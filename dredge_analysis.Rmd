---
title: "dredge analysis"
author: "Ross Cunning"
date: "2/26/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(tidyverse)
library(stringr)
library(lubridate)

getCoral <- function(s, t, c) {
  with(alldata, alldata[Site==s & Transect==t & Coral.ID==c, ])
}
```

# Monitoring of tagged corals during dredging

### Load data
```{r load_data_baseline}
# REEF 2
# File: Reef2_Baseline_POM_2013_050714.xlsx
# Worksheet: "Raw Data"
bl_r2 <- read.csv("data/to_analyze/Reef2_Baseline_POM_2013_050714.csv")
# Subset only tagged corals
bl_r2 <- droplevels(subset(bl_r2, bl_r2$Tagged.Coral..Y.N=="Y"))
bl_r2 <- within(bl_r2, {
  Date <- as.Date(Date, format="%m/%d/%y")
  Condition.Code <- as.character(Condition.QA.QC)
  Site <- factor(str_replace_all(SITE..e.g..R2N1.RR., "-..", ""))
  Week <- "BL"
  Transect <- str_extract(Transect..e.g..R2N1.RR.1., ".$")
  Species <- str_replace_all(Subcategory,
                             c("Stephanocoenia intersepta"="SINT",
                               "Diploria strigosa"="DSTR",
                               "Dichocoenia stokesii"="DSTO",
                               "Solenastrea bournoni"="SBOU",
                               "Montastraea cavernosa"="MCAV",
                               "Siderastrea siderea"="SSID",
                               "Meandrina meandrites"="MMEA",
                               "Diploria clivosa"="DCLI",
                               "Agaricia sp."="AGSP",
                               "Madracis formosa"="MFOR",
                               "Madracis decactis"="MDEC",
                               "Porites astreoides"="PAST",
                               "Diplora strigosa"="DSTR",
                               "Colpophyllia natans"="CNAT",
                               "Eusmilia fastigiata"="EFAS",
                               "Orbicella faveolata"="OFAV",
                               "Acropora cervicornis"="ACER",
                               "Agaricia agaricites"="AAGA"))
})
bl_r2 <- bl_r2[, c("Week", "Date", "Site", "Transect", "Coral.ID", "Species", "Condition.Code")]
# Aggregate all conditions for each observed coral
bl_r2 <- with(bl_r2, {
  aggregate(data.frame(Condition.Codes=Condition.Code), 
            by=list(Week=Week, Date=Date, Site=Site, Transect=Transect, 
                    Coral.ID=Coral.ID, Species=Species), 
            FUN=function(x) c(as.character(x)))
})
# Condition codes appear to have been all put together separated by slashes in the baseline data.
# separate these into a list to match subsequent data points
#bl_r2$Condition.Codes <- strsplit(bl_r2$Condition.Codes, split = "/")

# Condition codes appear to have been all put together separated by slashes in the baseline data.
# separate these into a list to match subsequent data points
bl_r2$Condition.Codes <- lapply(bl_r2$Condition.Codes, function(x) {
  c(unlist(strsplit(x, split = "/")))
})


####
# REEF 3
# File: Reef2_Baseline_POM_2013_050714.xlsx
# Worksheet: "Raw Data"
bl_r3 <- read.csv("data/to_analyze/Reef3_Baseline_POM_050714 (REVISED DOCUMENT).csv")
# Subset only tagged corals
bl_r3 <- droplevels(subset(bl_r3, bl_r3$Tagged.Coral..Y.N=="Y"))
bl_r3 <- within(bl_r3, {
  Date <- as.Date(Date, format="%m/%d/%y")
  Condition.Code <- as.character(QA.QC.Condition.Code)
  Site <- factor(str_replace_all(SITE..e.g..HBNC1.CP., "-..", ""))
  Week <- "BL"
  Transect <- str_extract(Transect..e.g..HBNA.1., ".$")
  Species <- str_replace_all(Subcategory,
                             c("Stephanocoenia intersepta"="SINT",
                               "Diploria strigosa"="DSTR",
                               "Dichocoenia stokesii"="DSTO",
                               "Dichocenia stokesii"="DSTO",
                               "Solenastrea bournoni"="SBOU",
                               "Montastraea cavernosa"="MCAV",
                               "Siderastrea siderea"="SSID",
                               "Meandrina meandrites"="MMEA",
                               "Diploria clivosa"="DCLI",
                               "Agaricia sp."="AGSP",
                               "Madracis formosa"="MFOR",
                               "Madracis decactis"="MDEC",
                               "Porites astreoides"="PAST",
                               "Diplora strigosa"="DSTR",
                               "Colpophyllia natans"="CNAT",
                               "Eusmilia fastigiata"="EFAS",
                               "Orbicella faveolata"="OFAV",
                               "Acropora cervicornis"="ACER",
                               "Agaricia agaricites"="AAGA",
                               "Porites porites"="PPOR",
                               "Agaricia lamarcki"="ALAM",
                               "Diploria labyrinthiformis"="DLAB"))
})
bl_r3 <- bl_r3[, c("Week", "Date", "Site", "Transect", "Coral.ID", "Species", "Condition.Code")]

# Aggregate all conditions for each observed coral
bl_r3 <- with(bl_r3, {
  aggregate(data.frame(Condition.Codes=Condition.Code), 
            by=list(Week=Week, Date=Date, Site=Site, Transect=Transect, 
                    Coral.ID=Coral.ID, Species=Species), 
            FUN=function(x) c(as.character(x)))
})

# Condition codes appear to have been all put together separated by slashes in the baseline data.
# separate these into a list to match subsequent data points
bl_r3$Condition.Codes <- lapply(bl_r3$Condition.Codes, function(x) {
  c(unlist(strsplit(x, split = "/")))
})

bl <- rbind(bl_r2, bl_r3)

```

```{r load_data_nov2013_mar2015, echo=FALSE, include=FALSE}
### compliance monitoring during the project
data <- read.csv("data/to_analyze/NEW_Offshore_Comp_Scleractinian_Cond_All_Weeks_8_10_15-QAQC.csv",
                 stringsAsFactors = FALSE)
data <- data[, 1:11]

data <- within(data, {
  Date <- as.Date(Date, format="%m/%d/%y")
  Condition.Code <- as.character(Condition.Code)
  Site <- factor(str_replace_all(Site, "-..", ""))
})
data <- droplevels(data)

# Identify rows with missing values
na_data <- data[rowSums(is.na(data)) > 0, ]
na_data
# Omit rows with missing data (only one row of all NAs...)
data <- na.omit(data)

# Look for errors in the data (date should correspond to week)
levels(droplevels(interaction(data$Date, data$Week)))
# 2014-11-25 should be 2013-11-25 because it is Week #1
data[data$Date=="2014-11-25", "Date"] <- as.Date("2013-11-25")
# Look for errors in the data (date should correspond to week)
levels(droplevels(interaction(data$Date, data$Week)))
# 2013-04-02 should be 2014-04-02
data[data$Date=="2013-04-02", "Date"] <- as.Date("2014-04-02")
# Look for errors in the data (date should correspond to week)
levels(droplevels(interaction(data$Date, data$Week)))
# Why does "Week 27" include dates fom May 22 until July 23, 2014?
# Looks like a mistake from filling down Date in Excel for Surveyor MLR 
# Change all Week 27 dates greater than May 23, 2014 to May 23, 2014
data[data$Date > "2014-05-23" & data$Week==27 & data$Surveyor=="MLR", "Date"] <- as.Date("2014-05-23")
# Look for errors in the data (date should correspond to week)
levels(droplevels(interaction(data$Date, data$Week)))
# 2020-05-29 should be 2014-05-29
data[data$Date=="2020-05-29", "Date"] <- as.Date("2014-05-29")
# Look for errors in the data (date should correspond to week)
levels(droplevels(interaction(data$Date, data$Week)))
# Change Week '66/67' to 67
data[data$Week=="66/67", "Week"] <- 67
# Change Week '69/70' to 70
data[data$Week=="69/70", "Week"] <- 70
# Rows with dat 2013-12-10 say either Week 4 or Week 7... Week 7 appears to be wrong. 
data[data$Date=="2013-12-10" & data$Week==7, "Week"] <- 4
# 2014-01-15 should be Week 9, not Week 8. (both present in data)
data[data$Date=="2014-01-15" & data$Week==8, "Week"] <- 9

# Change "SBOU " to "SBOU"
data[data$Species=="SBOU ", "Species"] <- "SBOU"

data$Week <- as.integer(data$Week)
data$Site <- factor(data$Site)
levels(data$Site)
data$Species <- factor(data$Species)
levels(data$Species)
head(data)
data$unique.id <- interaction(data$Site, data$Transect, data$Coral.ID)
levels(data$Site)
sitesused <- c("R2NC1-LR", "R2NC2-RR", "R2NC3-LR", "R3NC1-LR", "HBNC1-CP", "HBN3-CP",
               "HBS4-CR", "HBS3-CP", "HBSC1-CP", "R2SC1-RR", "R2SC2-LR", "R2S1-RR", 
               "R2S2-LR", "R2N1-RR", "R2N2-LR", "R3SC2-LR", "R3SC3-SG", "R3S2-LR",
               "R3N1-LR")
## SUBSET ONLY THE 19 SITES IN THE REPORT?
#data <- data[data$Site %in% sitesused, ]
## SUBSET ONLY REEF 2 and 3 sites?
data <- droplevels(data[grepl("^R", data$Site), ])
##############

# Aggregate all conditions for each observed coral
data <- with(data, {
  aggregate(data.frame(Condition.Codes=Condition.Code), 
            by=list(Week=Week, Date=Date, Site=Site, Transect=Transect, 
                    Coral.ID=Coral.ID, Species=Species), 
            FUN=function(x) c(as.character(x)))
})
data <- data[with(data, order(Site, Transect, Coral.ID, Week)), ]
```

```{r load_data_aprmay2015}
# from file: NEW_Offshore_Compliance_Scleractinian_Cond_R2_R3_IMPACT_ASSESS_data TAGGED CORALS.xlsx
# worksheet name: IA TAGGED ONLY
ia <- read.csv("data/to_analyze/NEW_Offshore_Compliance_Scleractinian_Cond_R2_R3_IMPACT_ASSESS_data TAGGED CORALS.csv")
ia <- within(ia, {
  Date <- as.Date(Date, format="%m/%d/%y")
  Site <- factor(str_replace_all(Site, "-..", ""))
})
ia <- ia[, c(2, 1, 5, 7, 9, 10, 11)]
# Aggregate all conditions for each observed coral
ia <- with(ia, {
  aggregate(data.frame(Condition.Codes=Condition.Code), 
            by=list(Week=Week, Date=Date, Site=Site, Transect=Transect, 
                    Coral.ID=Coral.ID, Species=Species), 
            FUN=function(x) c(as.character(x)))
})

```

```{r load_data_junjuly2015}
# NEED TO ASSIGN CORRECT WEEK NUMBERS
ia2 <- read.csv("data/to_analyze/NEW_Offshore_Post_Construction_Data_Entry_ALL_Weeks_GOOD 151015.csv")
# Subset only tagged corals
ia2 <- ia2[ia2$Tagged.coral..Y.N.=="Y",]
# Subset only R2 R3
ia2 <- droplevels(ia2[grepl("^R", ia2$Site), ])
# Reformat date and site
ia2 <- within(ia2, {
  Date <- as.Date(Date, format="%m/%d/%y")
  Site <- factor(str_replace_all(Site, "-..", ""))
  Transect <- str_extract(Transect, ".$")
})
# Subset columns of interest
ia2 <- ia2[, c(2,1,3,4,22,23,24)]
# Aggregate all conditions for each observed coral
ia2 <- with(ia2, {
  aggregate(data.frame(Condition.Codes=Condition.Code.qaqc), 
            by=list(Week=Week, Date=Date, Site=Site, Transect=Transect, 
                    Coral.ID=Coral.ID, Species=Species), 
            FUN=function(x) c(as.character(x)))
})
```

```{r load_data_aug2016}
#### newer csi data - one year post-construction - permanent sites
csi <- read.csv("data/to_analyze/permanent_sites_impact_assessment_corals_2016_CSI_QAQC.csv", skip=1)
# Subset tagged corals only
csi <- subset(csi, Tagged.coral..Y.N.=="Y")
csi <- csi[,c(2,1,3,4,21,22,23)]
csi$Date <- as.Date(csi$Date, format="%m/%d/%y")
# Subset only R2 and R3
csi <- droplevels(csi[grepl("^R", csi$Site), ])


# Aggregate all conditions for each observed coral
csi <- with(csi, {
  aggregate(data.frame(Condition.Codes=Condition.Code.qaqc), 
            by=list(Week=Week, Date=Date, Site=Site, Transect=Transect, 
                    Coral.ID=Coral.ID, Species=Species), 
            FUN=function(x) c(as.character(x)))
})
csi <- csi[with(csi, order(Site, Transect, Coral.ID, Week)), ]
csi <- droplevels(csi)
```

```{r merge_data}
# Combine all data
alldata <- rbind(bl, data, ia, ia2, csi)

# Add grouping factors
alldata$Channel <- ifelse(grepl("C", alldata$Site), "control", "channelside")
alldata$reef <- substr(alldata$Site, 1, 2)
alldata$dir <- substr(alldata$Site, 3, 3)

# Find any remaining species names errors to fix
levels(droplevels(factor(alldata$Species)))
# Coral that was labele MDEC at all other time points was labeled MFOR once
alldata[alldata$Species=="MFOR", "Species"] <- "MDEC"
# Apparently MFER and MALI (Mycetolphyllia ferox vs. aliciae) were both used for some corals, rename to MYCE
alldata[alldata$Species=="MFER", "Species"] <- "MYCE"
alldata[alldata$Species=="MALI", "Species"] <- "MYCE"
alldata[alldata$Species=="Mycetophyllia ferox", "Species"] <- "MYCE"
# Change Orbicella annularis to OANN
alldata[alldata$Species=="Orbicella annularis", "Species"] <- "OANN"
# Change stephanocoenia intersepta to SINT
alldata[alldata$Species=="stephanocoenia intersepta", "Species"] <- "SINT"




# Check to make sure no errors/conflicts in species assignments
spp <- with(alldata, aggregate(Species, by=list(Site=Site, Transect=Transect, Coral.ID=Coral.ID), 
                     FUN=function(x) unique(c(as.character(x)))))
with(alldata, alldata[Site=="R3SC3" & Transect=="1" & Coral.ID=="1", ])
# There are several instances where a given Site-Transect-Coral.ID has multiple spp. assignments...
# Find which name was used most frequently for each Site-Transect-Coral.ID
which.spp <- with(alldata, {
  aggregate(data.frame(Species=Species), by=list(Site=Site, Transect=Transect, Coral.ID=Coral.ID), 
            FUN=function(x) {
              names(table(c(as.character(x))))[which.max(table(c(as.character(x))))]
            })
})
###### SO MANY SPP CONFLICTS ############
alldata[alldata$Site=="R3S1" & alldata$Transect=="3" & alldata$Coral.ID=="5", ]
# Reassign all values of Species for each coral to the correct (most freq used) Species
for (i in 1:nrow(which.spp)) {
  alldata[alldata$Site==which.spp[i, "Site"] & 
          alldata$Transect==which.spp[i, "Transect"] &
          alldata$Coral.ID==which.spp[i, "Coral.ID"],
          "Species"] <- which.spp[i, "Species"]
}

with(alldata, alldata[Site=="R2NC1" & Transect=="1" & Coral.ID=="1", ])

# Add column for individual coral unique identifier
alldata$coral <- with(alldata, interaction(Site, Transect, Coral.ID))
alldata <- droplevels(alldata)

# Bin by weeks
alldata$week <- week(alldata$Date)  # Get calendar week for each Date
alldata$week <- ifelse(year(alldata$Date)=="2014", alldata$week + 52,
                       ifelse(year(alldata$Date)=="2015", alldata$week + 104, alldata$week))
alldata$week <- alldata$week - week(min(alldata$Date))
```

Date range present in this dataset: 

`r range(alldata$Date)`

Numer of tagged corals at each site: 

```{r count_corals}
ncorals.site <- alldata %>% 
  group_by(Site) %>% 
  summarise(Colonies=nlevels(interaction(Transect, Coral.ID)))

data.frame(ncorals.site)
```

Total number of tagged corals:

`r data.frame("Total number of tagged corals"=sum(data.frame(ncorals.site)$Colonies))`

```{r toomany, include=FALSE}
# colonies from R2NC3 were not included in DCA's reporting because this "was a redundant control site with no channel-side pair" (p. 21 Post-Con report)... i see no reason to exclude those here?
# colonies that went missing were also excluded from DCA analysis.
# look at when "MIS" was recorded for these corals
alldata[grepl("MIS", alldata$Condition.Codes), ]
with(alldata, alldata[Site=="R2N1" & Transect=="2" & Coral.ID=="2", ])
with(alldata, alldata[Site=="R2N2" & Transect=="1" & Coral.ID=="4", ])
# sometimes corals were recorded as missing but then they were no longer missing at the next
# survey time. "temporarliy" missing colonies should not be excluded.... how to treat this?
```

### How many corals are dead for any reason?
```{r dead}
dead <- alldata %>%
  group_by(coral) %>%
  summarise(dead=any(grepl("DEAD", Condition.Codes)))
table(dead$dead)


alldata %>%
  group_by(Site) %>%
  summarise(prop=prop.table(table(grepl("DEAD", Condition.Codes)))[2])
```

### When was white plague disease first observed at each site?
```{r first_dis}
alldata %>%
  group_by(Site) %>%
  filter(grepl("WP", Condition.Codes)) %>%
  summarise(first.WP.obs=min(Date))

earlywp <- subset(alldata, Date <= "2014-12-31" & grepl("WP", Condition.Codes))
with(earlywp, earlywp[order(Date),])
nrow(earlywp)

# Get % of tagged corals at each site showing WP at each site

# Initial: when did >5% of all corals (all sites) have WP disease (might need to use Week instead of Date)
prop <- alldata %>%
  group_by(Site, Date) %>%
  summarise(prop=prop.table(table(grepl("WP", Condition.Codes)))[2])
prop <- na.omit(prop)

# Find when >5% of diseas-susceptible spp showed disease

# Cross-check results reported in Precht et al., using R2NC and R2SC sites
bill <- subset(alldata, Site %in% c("R2NC1", "R2NC2", "R2SC1", "R2SC2"))
df <- subset(bill, Date=="2015-07-07")
nrow(df)
with(df, grepl("WP" %in% Condition.Codes))
table(with(df, grepl("WP", Condition.Codes)))
table(with(df, grepl("WP|DEAD", Condition.Codes)))

# bleaching on 9/12/14
df <- subset(bill, Date=="2014-09-12")
table(with(df, grepl("BL", Condition.Codes)))
table(with(df, grepl("PB|BL", Condition.Codes)))
table(with(df, grepl("P|PB|BL", Condition.Codes)))

# bleaching on 9/12/14
df <- subset(bill, Date=="2014-05-06")
table(with(df, grepl("BL", Condition.Codes)))
table(with(df, grepl("PB|BL", Condition.Codes)))
table(with(df, grepl("P|PB|BL", Condition.Codes)))

# wp on 11/18/2014
df <- subset(bill, Date=="2014-11-18")
table(with(df, grepl("WP", Condition.Codes)))
table(with(df, grepl("WP|DEAD", Condition.Codes)))

# wp on 06/17/2015
df <- subset(bill, Date=="2015-06-17")
df %>%
  group_by(Site) %>%
  summarise(propwp=prop.table(table(grepl("WP", Condition.Codes)))[2])
table(with(subset(df, Site=="R2NC1"), grepl("WP", Condition.Codes)))
table(with(subset(df, Site=="R2NC2"), grepl("WP", Condition.Codes)))

# wp on 07/07/2015
df <- subset(bill, Date=="2015-07-07")
table(with(df, grepl("WP", Condition.Codes)))


df <- subset(bill, Date<="2014-11-18")
ever.wp <- df %>%
  group_by(coral) %>%
  summarise(ever.wp=any(grepl("WP", Condition.Codes)))
table(ever.wp$ever.wp)

# Reconstruct prevalence of bleaching (P vs. PB vs. BL) by date including all four of these sites
bl <- bill %>%
  group_by(Date) %>%
  summarise(propbl=prop.table(table(grepl("BL", Condition.Codes)))[2],
            propblpb=prop.table(table(grepl("BL|PB", Condition.Codes)))[2],
            propblpbp=prop.table(table(grepl("BL|PB|P", Condition.Codes)))[2],
            propwp=prop.table(table(grepl("WP", Condition.Codes)))[2],
            propwpd=prop.table(table(grepl("WP|DEAD", Condition.Codes)))[2])
bl[is.na(bl$propbl), "propbl"] <- 0
bl[is.na(bl$propblpb), "propblpb"] <- 0
bl[is.na(bl$propblpbp), "propblpbp"] <- 0
bl[is.na(bl$propwp), "propwp"] <- 0
bl[is.na(bl$propwpd), "propwpd"] <- 0

ggplot(bl, aes(x=Date, y=propbl))  + geom_bar(stat="identity")
ggplot(bl, aes(x=Date, y=propblpb))  + geom_bar(stat="identity")
ggplot(bl, aes(x=Date, y=propblpbp))  + geom_bar(stat="identity")
ggplot(bl, aes(x=Date, y=propwp))  + geom_bar(stat="identity")
ggplot(bl, aes(x=Date, y=propwpd))  + geom_bar(stat="identity")



# Reconstruct prevalence of bleaching (P vs. PB vs. BL) by date and by Site including all four of these sites
bl <- bill %>%
  group_by(Date, Site) %>%
  summarise(propbl=prop.table(table(grepl("BL", Condition.Codes)))[2],
            propblpb=prop.table(table(grepl("BL|PB", Condition.Codes)))[2],
            propblpbp=prop.table(table(grepl("BL|PB|P", Condition.Codes)))[2],
            propwp=prop.table(table(grepl("WP", Condition.Codes)))[2],
            propwpd=prop.table(table(grepl("WP|DEAD", Condition.Codes)))[2])
bl[is.na(bl$propbl), "propbl"] <- 0
bl[is.na(bl$propblpb), "propblpb"] <- 0
bl[is.na(bl$propblpbp), "propblpbp"] <- 0
bl[is.na(bl$propwp), "propwp"] <- 0
bl[is.na(bl$propwpd), "propwpd"] <- 0

ggplot(subset(bl, Site=="R2NC2"), aes(x=Date, y=propbl))  + geom_bar(stat="identity")
ggplot(bl, aes(x=Date, y=propblpb))  + geom_bar(stat="identity")
ggplot(bl, aes(x=Date, y=propblpbp))  + geom_bar(stat="identity")
ggplot(subset(bl, Site=="R2NC2"), aes(x=Date, y=propwp)) + geom_bar(stat="identity")
ggplot(subset(bl, Site=="R2NC1"), aes(x=Date, y=propwp))  + geom_bar(stat="identity")
ggplot(subset(bl, Site=="R2SC1"), aes(x=Date, y=propwp))  + geom_bar(stat="identity")
ggplot(subset(bl, Site=="R2SC2"), aes(x=Date, y=propwp))  + geom_bar(stat="identity")
ggplot(bl, aes(x=Date, y=propwpd))  + geom_bar(stat="identity")



# Channel-side sites
bl <- alldata %>%
  group_by(Date, Site) %>%
  summarise(propbl=prop.table(table(grepl("BL", Condition.Codes)))[2],
            propblpb=prop.table(table(grepl("BL|PB", Condition.Codes)))[2],
            propblpbp=prop.table(table(grepl("BL|PB|P", Condition.Codes)))[2],
            propwp=prop.table(table(grepl("WP", Condition.Codes)))[2],
            propwpd=prop.table(table(grepl("WP|DEAD", Condition.Codes)))[2])
bl[is.na(bl$propbl), "propbl"] <- 0
bl[is.na(bl$propblpb), "propblpb"] <- 0
bl[is.na(bl$propblpbp), "propblpbp"] <- 0
bl[is.na(bl$propwp), "propwp"] <- 0
bl[is.na(bl$propwpd), "propwpd"] <- 0

ggplot(subset(bl, Site=="R2N1"), aes(x=Date, y=propwp))  + geom_bar(stat="identity")
ggplot(subset(bl, Site=="R2N2"), aes(x=Date, y=propwp))  + geom_bar(stat="identity")
ggplot(subset(bl, Site=="R2S1"), aes(x=Date, y=propwp))  + geom_bar(stat="identity")
ggplot(subset(bl, Site=="R2S2"), aes(x=Date, y=propwp))  + geom_bar(stat="identity")
ggplot(subset(bl, Site=="R3N1"), aes(x=Date, y=propwp))  + geom_bar(stat="identity")




# susceptible species only
sus <- c("CNAT", "DSTO", "DLAB", "EFAS", "MMEA", "MCAV", "ODIF", "DCLI", "DSTR", "SBOU")
billsus <- subset(bill, Species %in% sus)
table(billsus[!duplicated(billsus$coral), "Species"])
# of susceptible species, how many got WP ever
ever.wp <- billsus %>%
  group_by(coral) %>%
  summarise(ever.wp=any(grepl("WP", Condition.Codes)))
table(ever.wp$ever.wp)
all <- billsus %>%
  group_by(Species, coral) %>%
  summarise(ever.wp=any(grepl("WP", Condition.Codes)))
  

```

### When was bleaching first observed at each site?
```{r first_bleaching}
alldata %>%
  group_by(Site) %>%
  filter(grepl("BL", Condition.Codes)) %>%
  summarise(first.BL.obs=min(Date))
```

### What was the duration of bleaching at each site?
```{r bleaching_duration}
alldata %>%
  group_by(Site) %>%
  filter(grepl("BL", Condition.Codes)) %>%
  summarise(first.BL.obs=min(Date),
            last.BL.obs=max(Date))
```

### Average amount of partial mortality at each site?
```{r partial_mortality}
alldata %>%
  group_by(Site, coral) %>%
  filter(grepl("PM|UPM", Condition.Codes))# %>%
  summarise(prop.PM=m
```

### How many tagged corals are now missing?

### Run same analysis with baseline?

### How many had sedimentation stress before developing disease?

### Which colonies were cervicornis
```{r}
acer <- unique(alldata[alldata$Species=="ACER", "coral"])
ofav <- unique(alldata[alldata$Species=="OFAV", "coral"])
```

### How many corals are recorded as dead and then not dead
```{r}

first_dead <- alldata %>%
  group_by(coral) %>%
  filter(grepl("DEAD", Condition.Codes)) %>%
  summarise(first_dead=min(Date))

last_notdead <- alldata %>%
  group_by(coral) %>%
  filter(!grepl("DEAD", Condition.Codes)) %>%
  summarise(last_notdead=max(Date))

res <- merge(first_dead, last_notdead)

backtolife <- res %>%
  filter(last_notdead > first_dead)


```


# relationship between sedimentation and disease
# relationship between bleaching and disease