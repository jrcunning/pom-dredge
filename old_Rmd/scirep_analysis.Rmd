---
title: "Precht et al. 2016 Scientific Reports analysis"
author: "Ross Cunning"
date: "3/22/2018"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Load packages
library(tidyverse)
library(stringr)
library(lubridate)
library(readxl)

# Function for accessing data for a specific coral from full dataset
getCoral <- function(d, s, t, c) {
  with(d, d[Site==s & Transect==t & Coral.ID==c, ])
}

# Function for accessing corals with specific condition codes
hasCond <- function(cond, Condition.Codes) {
  unlist(lapply(Condition.Codes, FUN=function(x) any(grepl(cond, x))))
}
```

## Import data
```{r load_scirep_data}
scirep <- read_xlsx("data/raw/POM_R2_ControlData_Baseline_Post_construction.xlsx")

# Tidy data
names(scirep) <- c("Date", "Week", "Visit", "Transect", "Category", "Species",
                     "Coral.ID", "QAQC", "Condition.Code")
scirep <- scirep %>%
  mutate(Date = as.Date(Date),
         Week = as.factor(Week)) %>%
  separate(Transect, into = c("Site", "Site.2", "Transect")) %>%
  select(Date, Week, Site, Transect, Coral.ID, Species, QAQC, Condition.Code) %>%
  mutate(coral = interaction(Site, Transect, Coral.ID)) %>%
  filter(Species != "Tag not found") %>%
  droplevels()

# Find corals recorded as WP prior to being recorded as DEAD
wpdead <- scirep %>%
  filter(Condition.Code %in% c("WP", "DEAD")) %>%
  group_by(coral) %>%
  summarise(firstWP = as.character(min(Date[Condition.Code=="WP"], na.rm=T)),
            firstDEAD = as.character(min(Date[Condition.Code=="DEAD"], na.rm=T))) %>%
  drop_na() %>%
  mutate(WPbeforeDEAD = ifelse(as.Date(firstDEAD) > as.Date(firstWP), TRUE, FALSE))

# For these corals that had WP before DEAD, change DEAD to WPDEAD
wpdead2 <- scirep %>%
  filter(coral %in% wpdead$coral,
         Condition.Code=="DEAD") %>%
  mutate(Condition.Code="WPDEAD")

scirep <- bind_rows(scirep, wpdead2)

# Merge condition codes
scirep <- with(scirep, {
  aggregate(data.frame(Condition.Codes=Condition.Code), 
            by=list(Date=Date, Week=Week, Site=Site, Transect=Transect, 
                    Coral.ID=Coral.ID, Species=Species, coral=coral), 
            FUN=function(x) c(as.character(x)))
})

```

#### Check for conflicting species assignments for individual corals

```{r check_conflicts}
# How many corals have multiple species assignments? (e.g., indicative of an error in data entry)
sppcalls <- aggregate(data.frame(Species=scirep$Species), list(Site.Transect.CoralID=scirep$coral), 
                      FUN=function(x) unique(c(as.character(x))))
sppcalls

capture.output(sppcalls, file="scirep_spp_conflicts.txt")

table(sapply(sppcalls$Species, length) > 1)
```

Out of 115 corals, 23 have multiple species IDs associated with them at different points in time, indicative of some (unidentifiable) error in data entry. These errors might be resolved by going back to the raw data collection sheets.

#### Change conflicting species assignments to reflect most frequently assigned species

We attempt to fix some of these conflicting species assignments by changing species assignments for each coral (defined as unique site-transect-coralID) to the most frequently assigned species.

```{r fix_errors_scirep}
# There are several instances where a given Site-Transect-Coral.ID has multiple spp. assignments...
# Find which name was used most frequently for each Site-Transect-Coral.ID
which.spp <- with(scirep, {
  aggregate(data.frame(Species=Species), by=list(Site=Site, Transect=Transect, Coral.ID=Coral.ID), 
            FUN=function(x) {
              names(table(c(as.character(x))))[which.max(table(c(as.character(x))))]
            })
})

# Reassign all values of Species for each coral to the most frequently used species
for (i in 1:nrow(which.spp)) {
  scirep[scirep$Site==which.spp[i, "Site"] & 
          scirep$Transect==which.spp[i, "Transect"] &
          scirep$Coral.ID==which.spp[i, "Coral.ID"],
          "Species"] <- which.spp[i, "Species"]
}
```

```{r scirep_data_errors, eval=F, include=F}
# attempts to figure out if errors are clustered by week, indicating possibly incorrect transect number entered?
nlevels(scirep$coral)
sppcalls <- aggregate(scirep$Species, list(scirep$coral), 
                      FUN=function(x) unique(c(as.character(x))))
conflicts <- sppcalls[sapply(sppcalls$x, length) > 1, "Group.1"]

df <- scirep %>%
  filter(coral %in% conflicts) %>%
  arrange(Date) %>%
  droplevels()

dfs <- split(df, f=df$coral)
whichweek <- function(x) as.character(x[which(diff(abs(diff(as.numeric(as.factor(x$Species)))))==1)+2, "Week"])
weeks <- unlist(lapply(dfs, whichweek))
sort(weeks)

#scirep2 <- scirep %>%
#  group_by(date, site, transect, coral_id) %>%
#  summarise(condition_codes = list(condition_code))
```

## Analyze results reported in Precht et al. 2016

Block quotes are statements taken directly from the paper, and are followed by analysis attempting to evaluate and reproduce the claim.

------

### Dataset summary

> A total of 115 coral colonies, representing 13 coral species, were tagged for repeated monitoring at four sites on the inner reef tract in Miami-Dade County (Fig. 1). Coral colonies were monitored at least 40 times between October 19, 2013 and July 13, 2015.

Number of tagged corals: 
```{r n_tagged} 
with(scirep, nlevels(coral))

scirep %>%
  group_by(Site) %>%
  summarise(n_corals = length(unique(coral)))
```

Number of species:  
```{r n_spp}
with(scirep, nlevels(factor(Species)))
sort(unique(scirep$Species))
```

Number of times monitored:  
```{r n_times_monitored, fig.width=6, fig.height=2}
n_times <- scirep %>%
  group_by(coral) %>%
  summarise(n=nlevels(factor(Date)))
# Plot histogram of times observed
par(mar=c(3,3,1,1), mgp=c(1.5,0.25,0), tcl=-0.25)
hist(n_times$n, xlab="Number of times monitored", ylab="Number of colonies", main="all data")
```

Within this dataset, individual colonies were monitored between `r min(n_times$n)` and `r max(n_times$n)` times each. This is inconsistent with the statement that colonies were observed at least 40 times, and could mean that the dataset is incomplete.

------

### Peak of coral bleaching

------

> The peak of coral bleaching was recorded in September 2014. Specifically, the highest recorded bleaching prevalence occurred on September 12, 2014, when 84% (21 of 25 corals surveyed that day) showed signs of coral bleaching (Fig. 2).  

```{r peak_bleaching}
# Quantify bleaching (condition code "BL") on 9/12/14
scirep %>%
  filter(Date=="2014-09-12") %>%
  summarise(Date=unique(Date), n=n(), BL=sum(hasCond("^BL$", Condition.Codes)), freq.BL=BL/n) %>%
  knitr::kable()

# Quantify bleaching or partial bleaching (condition codes "BL" or "PB") on 9/12/14
scirep %>%
  filter(Date=="2014-09-12") %>%
  summarise(Date=unique(Date), n=n(), `BL or PB`=sum(hasCond("^BL$|^PB$", Condition.Codes)), 
            freq.BLorPB=`BL or PB`/n) %>%
  knitr::kable()

# Quantify bleaching, partial bleaching, or paling (condition codes "BL", "PB", or "P") on 9/12/14
scirep %>%
  filter(Date=="2014-09-12") %>%
  summarise(Date=unique(Date), n=n(), `BL, PB, or P`=sum(hasCond("^BL$|^PB$|^P$", Condition.Codes)), 
            freq.BL_PB_P=`BL, PB, or P`/n) %>%
  knitr::kable()
```

The number of corals recorded as BL on September 12, 2014 was only 4 out of 25 (16%). The number of corals recorded as BL or PB was 7 (28%), and the number recorded as BL, PB, or P was 21 (84%).

```{r peak_bleaching2_scirep, fig.width=10, fig.height=3}
# When was the peak of bleaching?
bleaching <- scirep %>%
  group_by(Date) %>%
  summarise(n=n(),
            freq.BL=sum(hasCond("^BL$", Condition.Codes))/n,
            freq.BLorPB=sum(hasCond("^BL$|^PB$", Condition.Codes))/n,
            freq.BLorPBorP=sum(hasCond("^BL$|^PB$|^P$", Condition.Codes))/n)

# Plot frequency of bleaching codes recorded over time            
ggplot(data=bleaching, mapping=aes(x=Date)) + ylab("Frequency") +
  geom_bar(aes(y=freq.BLorPBorP), stat="identity", fill="green") +  # Green is BL, PB, or P
  geom_bar(aes(y=freq.BLorPB), stat="identity", fill="blue") +  # Blue is BL or PB
  geom_bar(aes(y=freq.BL), stat="identity", fill="red")  # Red is BL only

# Maximum frequency of BL
bleaching[which.max(bleaching$freq.BL), c("Date", "n", "freq.BL")] %>% knitr::kable()

# Maximum frequency of BL or PB
bleaching[which.max(bleaching$freq.BLorPB), c("Date", "n", "freq.BLorPB")] %>% knitr::kable()

# Maximum frequency of BL or PB or P
bleaching[which.max(bleaching$freq.BLorPBorP), c("Date", "n", "freq.BLorPBorP")] %>% knitr::kable()
```

------

### First signs of white plague disease

------

> The first sign of a white-plague disease outbreak (prevalence > 5%) was noticed at the southern monitoring sites, near Virginia Key, on September 26, 2014...

```{r wp_frequency}
# Calculate frequency of WP at each Site on each Date
wp_scirep <- scirep %>%
  group_by(Site, Date) %>%
  summarise(freq.WP=sum(hasCond("^WP$", Condition.Codes))/n())

# What was the frequency of WP at the southern monitoring sites on September 26, 2014?
wp_scirep %>% filter(Date=="2014-09-26", Site %in% c("R2SC1", "R2SC2")) %>% knitr::kable()
```

These data show that the prevalence of WP on September 26, 2014 at the southern monitoring sites was 0% at R2SC1 and 4% at R2SC2.

```{r first_wp_over5}
# Find earliest Date with WP frequency greater than 5% at each Site
wp_scirep %>%
  group_by(Site) %>%
  summarise(`First WP > 5%`=min(Date[freq.WP > 0.05]),
            freq.WP=freq.WP[Date==`First WP > 5%`]) %>%
  knitr::kable()
```

We find that the first observation of ≥5% prevalence within the Precht et al. 2016 study sites was Oct 17 2014 at R2SC2, when the prevalence of WP was 8% of colonies.

```{r first_wp}
# Find earliest Date with WP observed at all
wp_scirep %>%
  group_by(Site) %>%
  summarise(`First WP > 0%`=min(Date[freq.WP > 0]),
            freq.WP=freq.WP[Date==`First WP > 0%`]) %>%
  knitr::kable()

scirep %>%
  filter(Date=="2014-08-13",
         hasCond("^WP$", Condition.Codes))

allwp <- scirep %>%
  group_by(Date, WP = hasCond("^WP$", Condition.Codes), Species) %>%
  summarise(n()) %>%
  filter(WP) %>%
  arrange(Date)
```


------

### White plague disease prevalence and dynamics

------

> ...by November 18, 15% of the tagged colonies showed outward signs of white-plague disease (Fig. 2).

```{r wp_2014-11-18}
# How many colonies had WP on November 18th, 2015?
scirep %>%
  filter(Date=="2014-11-18") %>%
  group_by(Site) %>%
  summarise(Date=unique(Date),
            n=n(),
            WP=sum(hasCond("^WP$", Condition.Codes)),
            freq.WP=WP/n) %>%
  knitr::kable()
```

We find that only 6 of 55 colonies (10.9%) observed on November 18th were recorded with the WP condition code.

```{r wp_or_dead_2014-11-18}
# How many colonies had WP or were DEAD on November 18th, 2015?
scirep %>%
  filter(Date=="2014-11-18") %>%
  summarise(Date=unique(Date),
            n=n(),
            WPorDEAD=sum(hasCond("^WP$|^WPDEAD$", Condition.Codes)),
            freq.WPorDEAD=WPorDEAD/n) %>%
  knitr::kable()
```

If both WP or WPDEAD are counted on November 18th, 2015, the frequency is 12.7% (7 out of 55). We are unable to reproduce the 15% number reported in the study.

------

> White-plague disease did not impact the northern monitoring sites (14 km north) until June 2015.

```{r wp_north}
# When was WP first observed at ≥5% prevalence at the northern sites?
wp_scirep %>%
  filter(Site %in% c("R2NC1", "R2NC2")) %>%
  group_by(Site) %>%
  summarise(`First WP > 5%`=min(Date[freq.WP > 0.05]),
            freq.WP=freq.WP[Date==`First WP > 5%`]) %>%
  knitr::kable()
```

We also find that WP was first observed ≥5% at the northern sites in June 2015.

------

> During the week of June 17 [2015], 17% of the tagged coral colonies at the northern monitoring sites were infected with white-plague disease.

```{r wp_2015-06-17}
# How many corals at northern sites had WP on June 17, 2015?
scirep %>%
  filter(Site %in% c("R2NC1", "R2NC2"), Date=="2015-06-17") %>%
  summarise(Date=unique(Date),
            n=n(),
            WP=sum(hasCond("^WP$", Condition.Codes)),
            freq.WP=WP/n) %>%
  knitr::kable()

# How many corals at northern sites had WP or WPDEAD on June 17, 2015?
scirep %>%
  filter(Site %in% c("R2NC1", "R2NC2"), Date=="2015-06-17") %>%
  summarise(Date=unique(Date),
            n=n(),
            WPorWPDEAD=sum(hasCond("^WP$|^WPDEAD$", Condition.Codes)),
            freq.WPorWPDEAD=WPorWPDEAD/n) %>%
  knitr::kable()

```

We find that out of 60 corals at the northern monitoring sites, 6 (10%) were observed with WP on June 17th, 2015. If WP and corals DEAD after WP are counted, it is still 6 out of 60 (10%).

------

> In total, white-plague disease was observed on seven of the 13 coral species identified at the four permanent monitoring sites (Table 1). 

```{wp_spp}
# How many species were observed to ever have WP?
scirep %>%
  group_by(Species) %>%
  summarise(`WP observed`=any(hasCond("^WP$", Condition.Codes))) %>%
  knitr::kable()
```

We find that only 6 species were impacted by WP. 

------

> The highest recorded prevalence of white-plague disease occurred on July 7, 2015, when 40% (22 of 55 corals surveyed that day) showed signs of white-plague disease infection (Fig. 2). 

```{r wp_2015-07-07, fig.width=10, fig.height=3}
# What is prevalence of WP on July 7th, 2015?
scirep %>%
  filter(Date=="2015-07-07") %>%
  summarise(Date=unique(Date), n=n(), 
            WP=sum(hasCond("^WP$", Condition.Codes)), 
            freq.WP=WP/n) %>%
  knitr::kable()

scirep %>%
  filter(Date=="2015-07-07") %>%
  summarise(Date=unique(Date), n=n(), 
            WPorWPDEAD=sum(hasCond("^WP$|^WPDEAD$", Condition.Codes)), 
            freq.WPorWPDEAD=WPorWPDEAD/n) %>%
  knitr::kable()
```

We find that on July 7, 2015, only 3 out of 55 corals observed (5.5%) were recorded as having WP. If we include corals that were recorded as having WP *and* corals that were previously recorded as having WP and are now recorded as dead (despite the fact the paper claims to be reporting corals that "showed signs of white-plague infection"), the total is 15 out of 55, or 27.3%. Therefore, we are unable to reproduce the result reported in the paper with the provided data.

When was the highest recorded prevalence of WP?

```{r scirep_highest_wp_prevalence, fig.width=10, fig.height=3}
# Graph white plague prevalence by Date (for all corals surveyed - may include multiple sites)
scirep_wp_by_date <- scirep %>%
  group_by(Date) %>%
  summarise(n=n(), WP=sum(hasCond("^WP$", Condition.Codes)), freq.WP=WP/n)

ggplot(data=scirep_wp_by_date, aes(x=Date, y=freq.WP)) + ylim(0,0.4) + geom_bar(stat="identity")

with(scirep_wp_by_date, scirep_wp_by_date[which.max(freq.WP), ]) %>% knitr::kable()
```

We find that the highest prevalence of WP on any Date (all sites observed) was 15% (9 of 60 colonies) on July 5th, 2015. 
```{r}
# Graph prevalence of WP or WPDEAD
scirep_wporwpdead_by_date <- scirep %>%
  group_by(Date) %>%
  summarise(n=n(), WPorWPDEAD=sum(hasCond("^WP$|^WPDEAD$", Condition.Codes)), 
            freq.WPorWPDEAD=WPorWPDEAD/n)

ggplot(data=scirep_wporwpdead_by_date, aes(x=Date, y=freq.WPorWPDEAD)) + ylim(0,0.4) + geom_bar(stat="identity")

with(scirep_wporwpdead_by_date, scirep_wporwpdead_by_date[which.max(freq.WPorWPDEAD), ]) %>% knitr::kable()
```

If we count corals that have active white plauge disease (WP) *and* corals that previously had WP disease and are now dead, we find that the highest prevalence on any date is 15 out of 55 (27.3%) on July 7th, 2015.

------

> Of the white-plague impacted species, the overall disease prevalence was 51% (35 of 69 corals surveyed).

```{r wp_freq_sus_spp}
# Susceptible species:
sus <- c("CNAT", "DSTO", "DLAB", "EFAS", "MMEA", "MCAV", "ODIF", "DCLI", "DSTR", "SBOU")

scirep_wp.corals <- scirep %>%
  filter(Species %in% sus) %>%
  group_by(Species, coral) %>%
  summarise(WP=any(hasCond("^WP$", Condition.Codes))) %>%
  select(WP) %>% table()

knitr::kable(rbind(scirep_wp.corals, TOTAL=colSums(scirep_wp.corals)))
```

We find that only 28 out of 69 colonies (40.6%) were recorded as having WP at any point in time.

How many corals at each stie were ever recorded as WP or WPDEAD?
```{r}
scirep %>%
  group_by(coral) %>%
  mutate(WPorWPDEAD = hasCond("WP", Condition.Codes)) %>%
  ungroup() %>% group_by(Site) %>%
  summarise(n.WPorWPDEAD = sum(WPorWPDEAD),
            n = unique(coral),
            freq = n.WPorWPDEAD / n)
```

------

### Relationship between bleaching and disease

------

> The majority (81%) of white-plague susceptible corals bleached, prior to becoming infected with the disease (Table 1). *Meandrina meandrites*, *Dichocoenia stokesi*, *Colpophyllia natans*, and *Pseudodiploria strigosa* were the most heavily impacted coral species, with 100% of tagged colonies being afflicted with white-plague disease. All colonies that showed signs of disease died, regardless of species. 

```{r scirep_bleaching_disease}
# Get list of WP-affected corals
scirep_wp.corals <- scirep %>%
  filter(Species %in% sus) %>%
  group_by(coral) %>%
  summarise(WP=any(hasCond("^WP$", Condition.Codes))) %>%
  filter(WP==TRUE)

# How many WP-affected corals bleached prior to becoming infected?
scirep_bleach_dis <- scirep %>%
  filter(coral %in% scirep_wp.corals$coral) %>%
  group_by(coral) %>%
  summarise(`P date`=min(Date[hasCond("^P$", Condition.Codes)]),
            `PB date`=min(Date[hasCond("^PB$", Condition.Codes)]),
            `BL date`=min(Date[hasCond("^BL$", Condition.Codes)]),
            `WP date`=min(Date[hasCond("^WP$", Condition.Codes)])) %>%
  arrange(`BL date`, `PB date`, `P date`, `WP date`)

knitr::kable(scirep_bleach_dis)

# Calculate number of corals with either BL, PB, or P prior to WP
scirep_bleach_dis %>%
  summarise(`n with WP`=n(),
            `BL first`=sum(`BL date` < `WP date`),
            `PB first`=sum(`PB date` < `WP date`),
            `P first`=sum(`P date` < `WP date`))
```

We find that only 3 out of 28 corals (10.7%) that had WP were recorded as bleached (BL) prior to becoming infected. 20 out of 28 (71%) were recorded as partially bleached (PB) prior to infection, while 28 out of 28 (100%) were recorded as pale (P) prior to infection. The designation of pale does not necessarily indicate bleaching, since corals typically pale in summer months even in the absence of bleaching.

However, to properly and statistically assess whether there is a relationship between bleaching and disease, the number of corals that bleached and did NOT get disease must also be considered.

```{r bleaching_nodisease}
# How many corals bleached but did NOT get WP disease?
blwp <- scirep %>%
  filter(Species %in% sus) %>%
  group_by(coral) %>%
  summarise(BL=any(hasCond("^BL$", Condition.Codes)),
            BLorPB=any(hasCond("^BL$|^PB$", Condition.Codes)),
            BLorPBorP=any(hasCond("^BL$|^PB$|^P$", Condition.Codes)),
            WP=any(hasCond("^WP$", Condition.Codes)))

# Note that this analysis needs to be improved by incorporating the time component -- currently, this code only looks at whether corals were recorded as BL/PB and WP, but not when.

res <- with(blwp, table(BLorPB, WP))
addmargins(res)

fisher.test(res)
```

We find that 50 of the 69 disease-susceptible corals 'bleached' (BL or PB), and of these, 20 got WP disease (40%), but 30 did not (60%). We find a similar incidence of disease among corals that did not bleach, with 8 out of 19 (42%) having the disease, and 11 (58%) not having disease. With Fisher's exact test, we find no relationship between bleaching (BL or PB) and disease (WP) (p-value=1).

------

### Relationship between sedimentation stress and disease

-----

```{r sed_disease}
# How many corals had sedimentation stress and disease?
sedwp <- scirep %>%
  filter(Species %in% sus) %>%
  group_by(coral) %>%
  summarise(SED=any(hasCond("^SED$", Condition.Codes)),
            SA=any(hasCond("^SA$", Condition.Codes)),
            PBUR=any(hasCond("^PBUR$", Condition.Codes)),
            BUR=any(hasCond("^BUR$", Condition.Codes)),
            PBURorBUR=any(hasCond("^PBUR$|^BUR$", Condition.Codes)),
            SAorPBUR=any(hasCond("^SA$|^PBUR$", Condition.Codes)),
            WP=any(hasCond("^WP$", Condition.Codes)))

# Note that this analysis needs to be improved by incorporating the time component -- currently, this code only looks at whether corals were recorded as SED/SA/PBUR/BUR and WP, but not when.

res <- with(sedwp, table(SA, WP))
addmargins(res)

fisher.test(res)
# There is no significant relationship between any of these factors and WP.
```

## Update based on Precht responses to initial inquiries
```{r}
wp77 <- scirep %>%
  filter(Date == "2015-07-07",
         hasCond("WP", Condition.Codes))
wp77

# Corals that Precht et al. indicate are "WP-impacted" on this date:
pr <- readxl::read_xlsx("data/precht_response/Copy of WP_and_Mortality for week7_7_2015.xlsx")
names(pr) <- c("Date", "Week", "Visit", "Transect", "Category", "Species",
                     "Coral.ID", "QAQC", "Condition.Code")
pr <- pr %>%
  separate(Transect, into = c("Site", "Site.2", "Transect")) %>%
  mutate(coral = interaction(Site, Transect, Coral.ID))

# Which corals are in Precht that are not in data?
pr$coral
wp77$coral
setdiff(pr$coral, wp77$coral)
```


```{r}
pr2 <- readxl::read_xlsx("data/precht_response/Copy of R2_Ctrls_PCWK4_Verify.xlsx", "POST CON WEEK 4 RAW DATA")
names(pr2) <- c("Date", "Week", "Visit", "Transect", "Category", "Species",
                "Coral.ID", "QAQC", "Condition.Code", "SED/DIS", "COLONY COUNT", "PLAGUE RELATED",
                "PLAGUE COUNT", "BLEACH COUNT")
pr2 <- pr2 %>%
  separate(Transect, into = c("Site", "Site.2", "Transect")) %>%
  mutate(coral = interaction(Site, Transect, Coral.ID)) %>%
  select(Date, Week, Site, Transect, Species, Coral.ID, coral, Condition.Code, `PLAGUE RELATED`)

# sent a sheet of 7-11 and 7-13-15 data with "plauge related" column indicating if coral had WP or was thought to have died from WP. 
plague <- filter(pr2, `PLAGUE RELATED`=="PLAGUE") %>% select(coral) # corals assumed to be WP or WPDEAD

#scirep %>%
#  filter(coral %in% plague$coral) %>%
#  mutate(Condition.Codes = lapply(Condition.Codes, function(x) gsub("DEAD", "WPDEAD", x)))

scirep2 <- scirep %>%
  mutate(Condition.Codes = ifelse(coral %in% plague$coral,
                                  lapply(Condition.Codes, function(x) gsub("^DEAD$", "WPDEAD", x)),
                                  Condition.Codes))
```

> The highest recorded prevalence of white-plague disease occurred on July 7, 2015, when 40% (22 of 55 corals surveyed that day) showed signs of white-plague disease infection (Fig. 2). 

```{r wp_2015-07-07, fig.width=10, fig.height=3}
# What is prevalence of WP on July 7th, 2015?
scirep2 %>%
  filter(Date=="2015-07-07") %>%
  summarise(Date=unique(Date), n=n(), 
            WP=sum(hasCond("^WP$", Condition.Codes)), 
            freq.WP=WP/n) %>%
  knitr::kable()

scirep2 %>%
  filter(Date=="2015-07-07") %>%
  summarise(Date=unique(Date), n=n(), 
            WPorWPDEAD=sum(hasCond("^WP$|^WPDEAD$", Condition.Codes)), 
            freq.WPorWPDEAD=WPorWPDEAD/n) %>%
  knitr::kable()
```

Yes, now the data match what is reported

> Of the white-plague impacted species, the overall disease prevalence was 51% (35 of 69 corals surveyed).

```{r wp_freq_sus_spp}
# Susceptible species:
sus <- c("CNAT", "DSTO", "DLAB", "EFAS", "MMEA", "MCAV", "ODIF", "DCLI", "DSTR", "SBOU")

scirep_wp.corals <- scirep2 %>%
  filter(Species %in% sus) %>%
  group_by(Species, coral) %>%
  summarise(WP=any(hasCond("^WP$|^WPDEAD$", Condition.Codes))) %>%
  select(WP) %>% table()

knitr::kable(rbind(scirep_wp.corals, TOTAL=colSums(scirep_wp.corals)))

scirep_wp.coral.ids <- scirep2 %>%
  filter(Species %in% sus) %>%
  group_by(coral) %>%
  summarise(WP=any(hasCond("^WP$|^WPDEAD$", Condition.Codes))) %>%
  filter(WP) %>% select(coral)

scirep_wp.coral.ids  # 39 coral IDs that are 'WP-impacted' in the scirep dataset after manually updateing the ones that Precht et al. report to be PLAGUE impacted... but Precht et al. only report 35?
plague  # The 35 corals indicated in email attachment that are counted as WP-impacted
setdiff(scirep_wp.coral.ids$coral, plague$coral)
#"R2SC1.2.1"  "R2NC2.1.5"  "R2NC2.2.5"  "R2SC1.1.10"
getCoral(scirep, "R2SC1", 2, 1) %>% arrange(Date)
getCoral(scirep, "R2NC2", 1, 5) %>% arrange(Date)
getCoral(scirep, "R2NC2", 2, 5) %>% arrange(Date)
getCoral(scirep, "R2SC1", 1, 10) %>% arrange(Date)
```

We find that 39 were recorded as WP or WPDEAD at any point in time.


# Which dates are present in FDEP-provided data but missing from Scientific Reports dataset?
```{r}
missingdates <- setdiff(as.character(unique(precht$Date)), as.character(unique(scirep$Date)))
missingdates
```

# Re-evaluate more claims using 'updated' data (scirep2)

> The first sign of a white-plague disease outbreak (prevalence > 5%) was noticed at the southern monitoring sites, near Virginia Key, on September 26, 2014...

```{r wp_frequency}
# Calculate frequency of WP or WPDEAD at each Site on each Date
wp_scirep2 <- scirep2 %>%
  group_by(Site, Date) %>%
  summarise(WPorWPDEAD=sum(hasCond("^WP$|^WPDEAD$", Condition.Codes)), n=n(),
    freq.WPorWPDEAD=WPorWPDEAD/n)

# What was the frequency of WP at the southern monitoring sites on September 26, 2014?
wp_scirep2 %>% filter(Date=="2014-09-26", Site %in% c("R2SC1", "R2SC2")) %>% knitr::kable()
```

These data show that the prevalence of WP or WPDEAD (using updated classification) on September 26, 2014 at the southern monitoring sites was 0% at R2SC1 and 4% at R2SC2.

> ...by November 18, 15% of the tagged colonies showed outward signs of white-plague disease (Fig. 2).

```{r wp_2014-11-18}
# How many colonies had WP on November 18th, 2015?
scirep2 %>%
  filter(Date=="2014-11-18") %>%
  group_by(Site) %>%
  summarise(Date=unique(Date),
            n=n(),
            WP=sum(hasCond("^WP$|^WPDEAD$", Condition.Codes)),
            freq.WP=WP/n) %>%
  knitr::kable()
```

Now we get the 15%.

```{r wp_or_dead_2014-11-18}
# How many colonies had WP or were DEAD on November 18th, 2015?
scirep2 %>%
  filter(Date=="2014-11-18") %>%
  summarise(Date=unique(Date),
            n=n(),
            WPorDEAD=sum(hasCond("^WP$|^WPDEAD$", Condition.Codes)),
            freq.WPorDEAD=WPorDEAD/n) %>%
  knitr::kable()
```

Now we get the 15% number reported in the study.

> White-plague disease did not impact the northern monitoring sites (14 km north) until June 2015.

```{r wp_north}
# When was WP first observed at ≥5% prevalence at the northern sites?
wp_scirep2 %>%
  filter(Site %in% c("R2NC1", "R2NC2")) %>%
  group_by(Site) %>%
  summarise(`First WP > 5%`=min(Date[freq.WPorWPDEAD > 0.05]),
            freq.WPorWPDEAD=freq.WPorWPDEAD[Date==`First WP > 5%`]) %>%
  knitr::kable()
```

We also find that WP was first observed ≥5% at the northern sites in June 2015.

------

> During the week of June 17 [2015], 17% of the tagged coral colonies at the northern monitoring sites were infected with white-plague disease.

```{r wp_2015-06-17}
# How many corals at northern sites had WPorWPDEAD on June 17, 2015?
scirep2 %>%
  filter(Site %in% c("R2NC1", "R2NC2"), Date=="2015-06-17") %>%
  summarise(Date=unique(Date),
            n=n(),
            WP=sum(hasCond("WP", Condition.Codes)),
            freq.WP=WP/n) %>%
  knitr::kable()

scirep2 %>%
  filter(Site %in% c("R2NC1", "R2NC2"), Date=="2015-06-17") %>%
  summarise(Date=unique(Date),
            n=n(),
            WP=sum(hasCond("^WP$", Condition.Codes)),
            WPDEAD=sum(hasCond("^WPDEAD$", Condition.Codes)),
            freq.WP=(WP+WPDEAD)/n) %>%
  knitr::kable()
```

We now get the 17%.

------

> In total, white-plague disease was observed on seven of the 13 coral species identified at the four permanent monitoring sites (Table 1). 

```{wp_spp}
# How many species were observed to ever have WP?
scirep2 %>%
  group_by(Species) %>%
  summarise(`WP observed`=any(hasCond("WP", Condition.Codes))) %>%
  knitr::kable()
```

We now get 7. 

------

> The highest recorded prevalence of white-plague disease occurred on July 7, 2015, when 40% (22 of 55 corals surveyed that day) showed signs of white-plague disease infection (Fig. 2). 

```{r wp_2015-07-07, fig.width=10, fig.height=3}
# What is prevalence of WP on July 7th, 2015?
scirep2 %>%
  filter(Date=="2015-07-07") %>%
  summarise(Date=unique(Date), n=n(), 
            WP=sum(hasCond("WP", Condition.Codes)), 
            freq.WP=WP/n) %>%
  knitr::kable()
```

We now get the 40%.

------

> Of the white-plague impacted species, the overall disease prevalence was 51% (35 of 69 corals surveyed).

```{r wp_freq_sus_spp}
# Susceptible species:
sus <- c("CNAT", "DSTO", "DLAB", "EFAS", "MMEA", "MCAV", "ODIF", "DCLI", "DSTR", "SBOU")

scirep2_wp.corals <- scirep2 %>%
  filter(Species %in% sus) %>%
  group_by(Species, coral) %>%
  summarise(WP=any(hasCond("^WP$|^WPDEAD$", Condition.Codes))) %>%
  select(WP) %>% table()

knitr::kable(rbind(scirep2_wp.corals, TOTAL=colSums(scirep2_wp.corals)))
```

Now we find that 39 corals had WP or updated WPDEAD?

How many corals at each site were ever recorded as WP or WPDEAD?
```{r}
scirep2 %>%
  group_by(coral) %>%
  mutate(WPorWPDEAD = hasCond("WP", Condition.Codes)) %>%
  ungroup() %>% group_by(Site) %>%
  summarise(n.WPorWPDEAD = sum(WPorWPDEAD),
            n = unique(coral),
            freq = n.WPorWPDEAD / n)
```

How many corals were recorded as WP but then did not die?
```{r}
# Get list of WP-affected corals
scirep2_wp.corals <- scirep2 %>%
  filter(Species %in% sus) %>%
  group_by(coral) %>%
  summarise(WP=any(hasCond("^WP$", Condition.Codes))) %>%
  filter(WP==TRUE)
scirep2_wp.corals

wp_dead <- scirep2 %>%
  filter(coral %in% scirep2_wp.corals$coral) %>%
  group_by(coral) %>%
  summarise(wpthendied = any(hasCond("DEAD", Condition.Codes)))
wp_dead
table(wp_dead$wpthendied)

# corals that were recorded as WP but were not ever recorded as DEAD
setdiff(scirep2_wp.corals$coral, (wp_dead %>% filter(wpthendied))$coral)
 # "R2SC1.2.1"  "R2SC1.3.1"  "R2SC1.1.2"  "R2NC2.3.2"  "R2NC2.1.3"  "R2SC1.1.4"  "R2NC2.3.4"  "R2NC2.1.5" 
 # "R2NC2.2.5"  "R2NC1.3.5"  "R2NC1.3.6"  "R2NC2.2.8"  "R2NC2.1.9"  "R2SC1.1.10" "R2NC2.3.10"
getCoral(alldata, "R2SC1", 2, 1) %>% arrange(Date)
getCoral(alldata, "R2SC1", 3, 1) %>% arrange(Date)
getCoral(alldata, "R2SC1", 1, 2) %>% arrange(Date)
getCoral(alldata, "R2SC1", 3, 1) %>% arrange(Date)
getCoral(alldata, "R2NC2", 3, 2) %>% arrange(Date)
```

------

### Relationship between bleaching and disease

------

Total prevalence of "bleaching", counted as BL, PB, or P, by species (to compare with Precht et al. Table 1)

```{r}
scirep2 %>%
  group_by(Species, coral) %>%
  summarise(BL = any(hasCond("^P$|^PB$|^BL$", Condition.Codes))) %>%
  select(BL) %>% table()

scirep2 %>%
  group_by(Species, coral) %>%
  summarise(BL = any(hasCond("^PB$|^BL$", Condition.Codes))) %>%
  select(BL) %>% table()

#REPRODUCE PRECHT ET AL TABLE 1 USING PB|BL|P AND PB|BL -- COMPARE TO THEIR NUMBERS
```


> The majority (81%) of white-plague susceptible corals bleached, prior to becoming infected with the disease (Table 1). *Meandrina meandrites*, *Dichocoenia stokesi*, *Colpophyllia natans*, and *Pseudodiploria strigosa* were the most heavily impacted coral species, with 100% of tagged colonies being afflicted with white-plague disease. All colonies that showed signs of disease died, regardless of species. 

```{r scirep_bleaching_disease}
# Get list of WP-affected corals
scirep2_wp.corals <- scirep2 %>%
  filter(Species %in% sus) %>%
  group_by(coral) %>%
  summarise(WP=any(hasCond("WP", Condition.Codes))) %>%
  filter(WP==TRUE)

# How many WP-affected corals bleached prior to becoming infected?
scirep2_bleach_dis <- scirep2 %>%
  filter(coral %in% scirep2_wp.corals$coral) %>%
  group_by(coral) %>%
  summarise(`P date`=min(Date[hasCond("^P$", Condition.Codes)]),
            `PB date`=min(Date[hasCond("^PB$", Condition.Codes)]),
            `BL date`=min(Date[hasCond("^BL$", Condition.Codes)]),
            `WPorWPDEAD date`=min(Date[hasCond("^WP$|^WPDEAD$", Condition.Codes)])) %>%
  arrange(`BL date`, `PB date`, `P date`, `WPorWPDEAD date`)

knitr::kable(scirep2_bleach_dis)

# Calculate number of corals with either BL, PB, or P prior to WP
scirep2_bleach_dis %>%
  summarise(`n with WP`=n(),
            `BL first`=sum(`BL date` <= `WPorWPDEAD date`),
            `PB first`=sum(`PB date` <= `WPorWPDEAD date`),
            `P first`=sum(`P date` <= `WPorWPDEAD date`))
```


However, to properly and statistically assess whether there is a relationship between bleaching and disease, the number of corals that bleached and did NOT get disease must also be considered.

```{r bleaching_nodisease}
# How many corals bleached but did NOT get WP disease?
blwp <- scirep2 %>%
  filter(Species %in% sus) %>%
  group_by(coral) %>%
  summarise(BL=any(hasCond("^BL$", Condition.Codes)),
            BLorPB=any(hasCond("^BL$|^PB$", Condition.Codes)),
            BLorPBorP=any(hasCond("^BL$|^PB$|^P$", Condition.Codes)),
            WP=any(hasCond("^WP$|^WPDEAD$", Condition.Codes)))

# Note that this analysis needs to be improved by incorporating the time component -- currently, this code only looks at whether corals were recorded as BL/PB and WP, but not when.

res <- with(blwp, table(BLorPBorP, WP))
addmargins(res)

fisher.test(res)


```

We find that 50 of the 69 disease-susceptible corals 'bleached' (BL or PB), and of these, 20 got WP disease (40%), but 30 did not (60%). We find a similar incidence of disease among corals that did not bleach, with 8 out of 19 (42%) having the disease, and 11 (58%) not having disease. With Fisher's exact test, we find no relationship between bleaching (BL or PB) and disease (WP) (p-value=1).



-----

```{r}

```

