---
title: "dredge_manuscript"
author: "Ross Cunning"
date: "4/25/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lsmeans)
library(multcomp)
library(tidyverse)
library(cowplot)
```

# Sediment Depth

```{r}
seddepth <- read.csv("data/DEP_responsive_records_May_2017/Copy of Cross_site_sediment_data_Port_Miami_Impact_Assessment _2-6-17.csv")

seddepth <- seddepth[, c(2,3,6,8,9,10,11,12)]
colnames(seddepth) <- c("Site", "Transect", "Position", "SedDepth", "Exposed.HB", "Sed.over.HB", "Sed.Only", "SedType")
seddepth$Site <- as.character(seddepth$Site)

seddepth$reef <- substr(seddepth$Site, 1, 2)

# Correct site labels
seddepth[seddepth$Site=="R2N1-350-RR", "Site"] <- "R2N-350-RR"
seddepth$dist <- do.call(rbind, lapply(strsplit(seddepth$Site, "-"), "[", 2))
head(seddepth)


# Only permanent sites
perm <- subset(seddepth, !grepl("[0-9]", seddepth$dist))
perm <- droplevels(perm)
levels(factor(perm$Site))
mod <- lm(SedDepth ~ Site, data=perm)
anova(mod)
res <- cld(lsmeans(mod, specs="Site"))
res

plot(lsmeans(mod, specs="Site"), xlab="Sediment depth (cm)")
```

```{r, eval=F}
# Distance sites
dist <- subset(seddepth, grepl("[0-9]", seddepth$dist))
dist <- droplevels(dist)
levels(factor(dist$dist))
mod <- lm(SedDepth ~ Site, data=dist)
res <- cld(lsmeans(mod, specs="Site"))
res
plot(res)


mod <- lm(SedDepth ~ Site, data=seddepth)
res <- cld(lsmeans(mod, specs="Site"))
res
plot(res)



# texture
seddepth$SedType <- as.character(seddepth$SedType)
seddepth[which(seddepth$SedType==""), "SedType"] <- NA
seddepth[which(seddepth$SedType=="Corse"), "SedType"] <- "Coarse"
sedtex <- seddepth[!is.na(seddepth$SedType), ]

plot(table(sedtex$Site, sedtex$SedType)[,c(2,3,1)])

st <- prop.table(table(sedtex$Site, sedtex$SedType), margin=1)

stord <- st[c(10,11,7,8,1,2,3,4,5,6,9,12,13,14),]

png("texture.png", width=5, height=5, units="in", res=300)
par(mar=c(6,5,5,2))
barplot(t(stord[c(1,2,12,13,14), ]), col=c("white", "black", "gray"), las=2,
        ylab="Proportion of observations")
legend("top", pch=22, pt.cex=3, legend=c("Coarse", "Mixed", "Fine"),
       pt.bg=c("white", "gray", "black"), inset=c(0,-0.3), xpd=NA)
dev.off()

barplot(t(stord), col=c("white", "black", "gray"), las=2,
        ylab="Proportion of observations")
legend("top", pch=22, pt.cex=3, legend=c("Coarse", "Mixed", "Fine"),
       pt.bg=c("white", "gray", "black"), inset=c(0,-0.3), xpd=NA)
```


# Octocoral density

### Baseline data for octocoral density from 2010
```{r}
# Baseline data for octocoral density from 2010
#2010 was 10m long transects
dens2010 <- readxl::read_xlsx(path = "data/Density_Data/Miami Quantitative Study Raw Data forAppendix.xlsx")
dens2010 <- select(dens2010, 2, 3, 17, 18, 20)
names(dens2010) <- c("transect", "depth.ft", "category", "subcategory", "diameter.cm")
## Remove transects that contain a "D" -- are these deep transects?
dens2010 <- filter(dens2010, !grepl("D", transect))

l <- nchar(dens2010$transect)
dens2010$site <- substr(dens2010$transect, 1, ifelse(l==6, 3, 4))
dens2010$dist <- as.numeric(substr(dens2010$transect, ifelse(l==6, 4, 5), ifelse(l==6, 6, 7)))

dens2010 <- dens2010 %>%
  #separate(transect, into = c("site", "dist"), sep = ifelse(nchar(.)==6, 3, 4), convert = TRUE) %>%
  mutate(category = str_replace_all(category, "Octocoral", "octocoral"))

dens2010octo <- dens2010 %>%
  filter(category == "octocoral") %>%
  group_by(site, dist) %>%
  summarise(nocto = n(),
          dens.m2 = nocto / 10)     # Assuming each transect was 10x1 m

ggplot(dens2010octo, aes(x=dist, y=nocto)) +
  facet_grid(~ site) +
  geom_point() +
  geom_smooth()


# cross check against report
```

### Data for octocoral density from 2013
```{r}
# Data for octocoral density from Oct. 2013
# 2013 was three 20m long transects (x1m wide)
# Reef 2
dens2013r2 <- readxl::read_xlsx(path  = "data/Density_Data/Reef2_Baseline_POM_2013_050714.xlsx",
                                sheet = "Raw Data")
dens2013r2 <- dens2013r2[, c(1,5,6,8:12)]
names(dens2013r2) <- c("date", "site", "transect", "category", "subcategory", "total.count", "density.col.m2", "depth.ft")
# Reef 3
dens2013r3 <- readxl::read_xlsx(path  = "data/Density_Data/Reef3_Baseline_POM_050714 (REVISED DOCUMENT).xlsx",
                                sheet = "Raw Data")
dens2013r3 <- dens2013r3 %>% select(1,3,4,6,7,8,9,10)
names(dens2013r3) <- c("date", "site", "transect", "category", "subcategory", "total.count", "density.col.m2", "depth.ft")
# Combine reef2 and ref3
dens2013 <- bind_rows(dens2013r2, dens2013r3)
dens2013 <- dens2013 %>% separate(site, into = c("site", "site2"))

dens2013octo <- dens2013 %>%
  filter(category=="Octocoral") %>%
  group_by(site) %>%
  summarise(n.transects = length(unique(transect)),             # Get number of transects performed per site
                  nocto = sum(total.count),                     # Add total Octocoral counts for each site
                dens.m2 = nocto / (20 * n.transects))     # Calculate total density (each transect = 20x1m)

dens2013octo

#cross check against report
dens2013octo
```

### Data for octocoral density from 2016 (April 2017 report) at permanent sites
```{r}
dens2016 <- readxl::read_xlsx(path = "data/Density_Data/permanent_sites_impact_assessment_sponges_octocorals_2016_CSI_QAQC.xlsx",
                              sheet = "Raw Data", skip = 1)
dens2016 <- dens2016 %>% select(1,3,4,18,19,21,22,23,26)
names(dens2016) <- c("date", "site", "transect", "category", "subcategory", "coral.id", "species", "condition.code.qaqc", "count.qaqc")

dens2016octo <- dens2016 %>%
  filter(category == "Octocoral") %>%
  group_by(site) %>%
  summarise(n.transects = length(unique(transect)),             # Get number of transects performed per site
                  nocto = sum(count.qaqc, na.rm = TRUE),        # Add total Octocoral counts for each site
                dens.m2 = nocto / (20 * n.transects))           # Calculate total density (each transect = 20x1m)
# Table 45 in April 2017 report
```

# Merge permanent site data together
```{r}
dens2010octo <- dens2010octo %>% mutate(year = 2010)
dens2013octo <- dens2013octo %>% mutate(year = 2013)
dens2016octo <- dens2016octo %>% mutate(year = 2016)

octo <- bind_rows(dens2013octo, dens2016octo)
octo
ggplot(octo, aes(x = site, y = dens.m2, color = year)) + geom_point()
```

### Data for octocoral density from 2016 (April 2017 report) at increasing distance from channel
```{r}
# find all file names ending in .xlsx 
files <- list.files(path = "data/Density_Data/2016 cross-transect data/Entered Data/",
                    pattern = "^[^~].*.xlsx", recursive = TRUE, full.names = TRUE)
files
# remove files manually if multiple files for a given transect
files <- files[-c(24,25,28,30,32,33,36)]


# read in OCTOCORALS sheet from each xlsx file
cs2016 <- files %>%
  map(readxl::read_xlsx, sheet = "OCTOCORALS") %>%    # read in all the files individually
  reduce(bind_rows)                                   # reduce with rbind into one dataframe

cs2016 <- cs2016 %>% select(1, 2, 3, 8, 9, 11)
names(cs2016) <- c("area", "station", "date", "transect", "position.m", "genus")

cs2016octo <- cs2016 %>%
  filter(grepl("^R2|^R3", station)) %>%  # get only R2 and R3 survey sites
  group_by(station) %>%
  summarise(nocto   = n(),
            dens.m2 = nocto / 50) %>%    # Total of 50m2 surveyed, according to Oct2017 report p. 23
  arrange(station)

cs2016octo <- cs2016octo %>%
  mutate(distance = case_when(           # Add distances from channel for each station
    station=="R2N1-RR" ~ "28",
    station=="R2NC2-RR" ~ "9380",
    station=="R2N2-LR" ~ "18",
    station=="R2NC1-LR" ~ "9380",
    station=="R2NC3-LR" ~ "9380",
    station=="R2S1-RR" ~ "23",
    station=="R2SC1-RR" ~ "1270",
    station=="R2S2-LR" ~ "21",
    station=="R2SC2-LR" ~ "1270",
    station=="R3N1-LR" ~ "23",
    station=="R3NC1-LR" ~ "9380",
    station=="R3S2-LR" ~ "21",
    station=="R3SC2-LR" ~ "1300",
    TRUE ~ str_extract(station, "[[:digit:]]{2,3}"))) %>%
  mutate(area = str_extract(station, "^R.."),
         type = str_extract(station, ".R$")) %>%
  type_convert()
  

cs2016octo %>%
  filter(distance < 1000) %>%
  ggplot(aes(x = distance, y = dens.m2)) + facet_wrap(~area) +
  geom_point() + geom_smooth(method = "lm")

ggplot(dens2010octo, aes(x=dist, y=dens.m2)) +
  facet_wrap(~ site) +
  geom_point() +
  geom_smooth(method = "lm")

# combine data together
# 2010 R2N transects match up with 2016 R2N-RR
R2N2016 <- cs2016octo %>%
  filter(area=="R2N", type=="RR") %>%
  select(area, distance, dens.m2) %>%
  mutate(year = "2016")
R2N2010 <- dens2010octo %>%
  filter(site=="R2N") %>%
  select(site, dist, dens.m2) %>%
  rename(area = site, distance = dist) %>%
  mutate(year = "2010")

R2N <- bind_rows(R2N2010, R2N2016)
ggplot(filter(R2N, distance < 2500), aes(x = distance, y = dens.m2, color = year)) + 
  geom_point() +
  geom_smooth(method="lm", aes(group = year))
##### THIS REPRODUCES FIGURE 54 IN THE OCT2017 REPORT AND IT LOOKS EXACTLY THE SAME

```


# Just look at R2N channelside and control permanent sites data from 2013 and 2016 (not cross-site dataset)
```{r}

R2Nps <- bind_rows(
  dens2013octo %>%
    filter(grepl("R2N", site)) %>%
    mutate(year = "2013"),
  dens2016octo %>%
    filter(grepl("R2N", site)) %>%
    mutate(year = "2016")
) %>% filter(site != "R2NC2")  # bc decrease in octo dens at this site attributed to lobster fishing damage

R2Nps
perm <- ggplot(R2Nps, aes(x = site, y = dens.m2, fill = year)) + 
  geom_bar(stat = "identity", position = "dodge") + ylim(0,20)
perm
# permanent site data (2013, 2016) show everything goes DOWN in 2016

# but cross-site data (2010, 2016) show everything goes UP in 2016.
cross <- R2N %>% ungroup %>%
  filter(distance < 500) %>%                                 # because 2010 data doesn't go past 500m
  group_by(year, interv = cut_width(distance, 100)) %>%      # bin because distances are diff 2010vs2016
  summarise(mean.dens.m2 = mean(dens.m2)) %>%                # average densities measured in bins
  ggplot(aes(x = interv, y = mean.dens.m2, fill = year)) + 
    geom_bar(stat = "identity", position = "dodge") + ylim(0,20)
cross
    
    
plot_grid(perm, cross, labels = c("permanent site data",
                                  "cross-site dataset\n(corresponds to R2N1)"))
```

