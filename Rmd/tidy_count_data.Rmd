---
title: "tidy_density_data.Rmd"
author: "Ross Cunning"
date: "5/28/2018"
output: html_document
---

Import and tidy density data for scleractinians and octocorals

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = normalizePath(".."))

# Load packages
library(tidyverse)
library(stringr)
library(lubridate)
library(readxl)
library(janitor)
```


# Import baseline data from 2009
```{r}
# Import and tidy baseline density data from 2009 (10m transects)
dens2009 <- readxl::read_xlsx(
  path = "data/Density_Data/Miami Quantitative Study Raw Data forAppendix.xlsx") %>% 
  clean_names() %>%
  rename(site = area_e_g_r2n, transect = transect_e_g_r2n_10, diameter = diameter_cm) %>%
  select(site, transect, category, subcategory, diameter) %>%
  filter(!grepl("D", transect)) %>%  # Remove transects that contain a "D". These were 'direct impact'
                                     # areas where reef was removed, so no later data for comparison
  mutate(site = substr(transect, 1, ifelse(nchar(transect) == 6, 3, 4)),   # Get site name
         site2 = case_when(site == "R2N" ~ "RR",  # 2009 R2N transects match up with 2016 R2N-RR
                           site == "R2S" ~ "",     # GET THIS INFO
                           site == "R3N" ~ "",     # GET THIS INFO
                           site == "R3S1" ~ "CP",
                           site == "R3S2" ~ "LR",
                           site == "R3S3" ~ "SG"),
         dist = as.numeric(substr(transect, ifelse(nchar(transect) == 6, 4, 5), # Get dist from channel
                                  ifelse(nchar(transect) == 6, 6, 7))),
         count = 1,                  # single observation per row
         date = ymd("2009-11-15"),   # add date (collected btw Oct 28 and Nov 24 2009, but not in data)
         transect_area_m2 = 10)      # each transect was 10 square meters

unique(dens2009$site)
```

# Import "baseline" data from 2013
```{r}
# Data from Oct - Dec 2013 (three 20m long transects (x1m wide))
# SOME SITES/transects DONE MORE THAN ONCE -- NEED TO INCLUDE DATE

# Reef 2
dens2013r2 <- readxl::read_xlsx(
  path  = "data/Density_Data/Reef2_Baseline_POM_2013_050714.xlsx", 
  sheet = "Raw Data", guess_max = 4000) %>%
  clean_names() %>%
  rename(site = site_e_g_r2n1_rr, transect = transect_e_g_r2n1_rr_1, 
         diameter = max_diameter_cm, count = total_count) %>%
  separate(site, into = c("site", "site2")) %>%
  mutate(diameter = as.numeric(diameter)) %>%
  select(date, site, transect, category, subcategory, diameter, count)


# Reef 3
dens2013r3 <- readxl::read_xlsx(
  path  = "data/Density_Data/Reef3_Baseline_POM_050714 (REVISED DOCUMENT).xlsx", sheet = "Raw Data") %>%
  clean_names() %>%
  rename(site = site_e_g_hbnc1_cp, transect = transect_e_g_hbna_1, 
         diameter = max_diameter, count = total_count) %>%
  separate(site, into = c("site", "site2")) %>%
  select(date, site, transect, category, subcategory, diameter, count)

# Combine reef 2 and reef 3 data
dens2013 <- bind_rows(dens2013r2, dens2013r3) %>%
  mutate(dist = NA,
         date = as.Date(date),
         transect_area_m2 = 20) %>%  # each transect was 20 square meters 
  mutate(count = ifelse(is.na(count), 1, count))            # ASSUME MISSING COUNTS ARE 1
```

# Import data from 2015 - permanent sites
```{r}
dens2015 <- readxl::read_xlsx(
  path = "data/raw/NEW_Offshore_Post_Construction_Data_Entry_ALL_Weeks_GOOD 151015.xlsx",
  guess_max = 10000) %>%
  clean_names() %>%
  rename(category = category_scleractinian_etc,
         subcategory = subcategory_species_or_genus,
         count = total_count, diameter = max_diameter) %>%
  separate(site, into = c("site", "site2")) %>%
  mutate(date = as.Date(date),                                # convert to Date
         dist = NA) %>%                                       # add dist column (NAs filled in later)
  filter(grepl("^R", site)) %>%                                    # select R2 and R3
  filter(!grepl("DEAD", condition_code_qaqc)) %>%              # EXCLUDE DEAD CORALS!
  select(date, site, transect, category, subcategory, diameter, count) %>%
  mutate(count = ifelse(is.na(count), 1, count)) %>%                # ASSUME MISSING COUNTS ARE 1
  mutate(date = if_else(is.na(date), as.Date("2015-06-22"), date)) %>%  # fill in missing date
  mutate(diameter = as.numeric(diameter)) %>%
  mutate(transect_area_m2 = 20)    # transects were 20 m2
```

# Import data from 2015 - other sites / distances from channel (where is this?)
```{r}
# Data collected ____________
dens2015other <- readxl::read_xlsx(
  path = "data/Density_Data/NEW_Offshore_Compliance_Scleractinian_Cond_R2_R3_IMPACT_ASSESS_comp_data.xlsx",
  sheet = "original_data"
)

# this data looks like up to 10 corals per transect were observed for condition codes, but does not look like all corals along the transects were counted
# do not use this data until methods are confirmed
  
```

# Import data from 2016 - permanent sites
```{r}
# Data collected August 2016
# need to include dat

## Sponges and octocorals are in one spreadsheet
dens2016octo <- readxl::read_xlsx(
  path = "data/Density_Data/permanent_sites_impact_assessment_sponges_octocorals_2016_CSI_QAQC.xlsx",
  sheet = "Raw Data", skip = 1) %>%
  clean_names() %>%
  rename(category = category_scleractinian_etc, subcategory = subcategory_genus_or_type,
         count = octo_sponge_zoanthid_count_qaqc) %>%
  filter(grepl("^R", site)) %>%     # filter reef 2 and reef 3 only
  filter(!grepl("DEAD", condition_code_qaqc)) %>%              # EXCLUDE DEAD CORALS!
  select(date, site, transect, category, subcategory, count) %>%
  mutate(count = ifelse(is.na(count), 1, count),            # ASSUME MISSING COUNTS ARE 1
         date = as.Date(date))

## Corals are in another spreadsheet
dens2016scler <- readxl::read_xlsx(
  path = "data/Density_Data/permanent_sites_impact_assessment_corals_2016_CSI_QAQC.XLSX",
  sheet = "Raw Data", skip = 1)  %>%
  clean_names() %>%
  rename(category = category_scleractinian_etc, subcategory = species,
         diameter = max_diameter) %>%
  filter(grepl("^R", site)) %>%     # filter reef 2 and reef 3 only
  filter(!grepl("DEAD", condition_code_qaqc)) %>%              # EXCLUDE DEAD CORALS!
  select(date, site, transect, category, subcategory, diameter) %>%
  mutate(count = 1,  # 1 coral per row (no count data in sheet)
         date = as.Date(date))
         
## Combine sponge, octocoral, and scleractinian data
dens2016 <- bind_rows(dens2016octo, dens2016scler) %>%
  mutate(dist = NA,
         transect = as.character(transect),
         transect_area_m2 = 20)     # each transect was 20 square meters
```

# Import data from 2016 - cross sites
```{r}
# find all file names ending in .xlsx 
files <- list.files(path = "data/Density_Data/2016 cross-transect data/Entered Data/",
                    pattern = "^[^~].*.xlsx", recursive = TRUE, full.names = TRUE)
# remove files manually if multiple files for a given transect
files <- files[-c(24,25,28,30,32,33,36)]


# read in OCTOCORALS sheet from each xlsx file
cs2016octo <- files %>%
  map(readxl::read_xlsx, sheet = "OCTOCORALS") %>%    # read in all the files individually
  reduce(bind_rows)                                   # reduce with rbind into one dataframe
# Tidy data
cs2016octo <- cs2016octo %>%
  clean_names() %>%
  filter(grepl("^R2|^R3", station)) %>%               # get only R2 and R3 survey sites
  rename(site = station, transect = transect_ns_or_ew,
         category = organism_type_scl_spo_octo, 
         subcategory = species_scl_genera_octo_morph_spo) %>%
  mutate(count = 1) %>%                               # single observation per row
  mutate(transect_area_m2 = case_when(transect == "EW" ~ 30,     # transect area, DCA 10/2017 p.23
                                      transect == "NS" ~ 20)) %>%  
  mutate(dist = str_extract(site, "[[:digit:]]{2,3}")) %>%      # extract distance from site name
  mutate(site2 = str_extract(site, "LR|RR")) %>%                 # extract LR or RR from site name
  mutate(site = str_extract(site, "R[^-|_]*")) %>%                 # extract base site form site name
  filter(!grepl("DEAD", condition_codes_all)) %>%              # EXCLUDE DEAD CORALS!
  select(date, site, site2, dist, transect, transect_area_m2, category, subcategory, count)


# read in CORALS sheet from each xlsx file
cs2016scler <- files %>%
  map(readxl::read_xlsx, sheet = "CORALS") %>%    # read in all the files individually
  reduce(bind_rows)                                   # reduce with rbind into one dataframe
# Tidy data
cs2016scler <- cs2016scler %>%
  clean_names() %>%
  filter(grepl("^R2|^R3", station)) %>%               # get only R2 and R3 survey sites
  rename(site = station, transect = transect_ns_or_ew,
         category = organism_type_scl_spo_octo, 
         subcategory = species_scl_genera_octo_morph_spo,
         diameter = size_cm) %>%
  mutate(count = 1) %>%                               # single observation per row
  mutate(transect_area_m2 = case_when(transect == "EW" ~ 30,     # transect area, DCA 10/2017 p.23
                                      transect == "NS" ~ 20)) %>%  
  mutate(dist = str_extract(site, "[[:digit:]]{2,3}")) %>%      # extract distance from site name
  mutate(site2 = str_extract(site, "LR|RR")) %>%                 # extract LR or RR from site name
  mutate(site = str_extract(site, "R[^-|_]*")) %>%                 # extract base site form site name
  filter(!grepl("DEAD", condition_codes_all)) %>%              # EXCLUDE DEAD CORALS!
  select(date, site, site2, dist, transect, transect_area_m2, category, subcategory, diameter, count)


# Combine octocoral and scleractinian data
cs2016 <- bind_rows(cs2016octo, cs2016scler) %>%
  mutate(dist = as.numeric(dist),
         date = as.Date(date))
```

# Combine all count data and add site metadata
```{r}
# Combine all count data and select octocorals and corals
all_counts <- data_frame(data = list(dens2009, dens2013, dens2015, dens2016, cs2016)) %>% unnest(data)

# Add site metadata
all_counts <- all_counts %>%
  mutate(year = year(date),                                      # add year column
         reef = str_sub(site, 1, 2),                             # add reef column (R2 or R3)
          dir = str_sub(site, 3, 3),                             # add direction (N or S)
         perm = case_when(nchar(site) == 3 | year == 2009 ~ "no",   # add permanent site (yes or no)
                          nchar(site) >= 4 & year != 2009 ~ "yes"),
      channel = ifelse(perm == "yes",
                       case_when(grepl("C", site) ~ "control",          # add control vs. channelside
                                !grepl("C", site) ~ "channelside"),
                       NA))

```

# Tidy and filter data
```{r}
# Tidy category names and filter only scleractinians and octocorals
all_counts <- all_counts %>%
  mutate(category = str_replace_all(category, 
           c("Scleractinian" = "scleractinian",
             "Octocoral" = "octocoral",
             "Ocotocoral" = "octocoral",
             "Coral" = "scleractinian",
             "CORAL" = "scleractinian"))) %>%
  filter(category == "scleractinian" | category == "octocoral")

# Tidy taxonomy
all_counts <- all_counts %>%
  mutate(subcategory = str_replace_all(subcategory,     # replace abbreviations with full names
           c("SINT" = "Stephanocoenia intersepta",
             "DSTO" = "Dichocoenia stokesii",
             "SBOU" = "Solenastrea bournoni",
             "MCAV" = "Montastraea cavernosa",
             "SSID" = "Siderastrea siderea",
             "SRAD" = "Siderastrea radians",
             "MMEA" = "Meandrina meandrites",
             "DCLI" = "Pseudodiploria clivosa",
             "AGSP" = "Agaricia sp.",
             "MFOR" = "Madracis formosa",
             "MDEC" = "Madracis decactis",
             "PAST" = "Porites astreoides",
             "DSTR" = "Pseudodiploria strigosa",
             "CNAT" = "Colpophyllia natans",
             "EFAS" = "Eusmilia fastigiata",
             "OFAV" = "Orbicella faveolata",
             "ACER" = "Acropora cervicornis",
             "AAGA" = "Agaricia agaricites",
             "MALI" = "Mycetophyllia aliciae",
             "SCUB" = "Scolymia cubensis",
             "DLAB" = "Diploria labyrinthiformis",
             "PPOR" = "Porites porites",
             "MFAV" = "Orbicella faveolata",
             "PCLI" = "Pseudodiplora clivosa",
             "AHUM" = "Agaricia humilis",
             "PSTR" = "Pseudodiploria strigosa",
             "ALAM" = "Agaricia lamarcki"))) %>%
  separate(subcategory, into = c("genus", "species")) %>%    # separate into genus and species
  mutate(genus = str_replace_all(genus,                      # fix genus spelling errors
           c("Briarieum" = "Briareum",
             "Dichocenia" = "Dichocoenia",
             "Diplora" = "Diploria",
             "Montastrea" = "Montastraea",
             "Muriceposis" = "Muriceopsis",
             "Pseudodiplora" = "Pseudodiploria",
             "Pseudoplexaua" = "Pseudoplexaura",
             "Pseudplexaura" = "Pseudoplexaura",
             "Psuedoplexaura" = "Pseudoplexaura",
             "^pterogorgia" = "Pterogorgia",
             "SID" = "Siderastrea",
             "siderastrea" = "Siderastrea",
             "stephanocoenia" = "Stephanocoenia",
             "^Coral" = "no_id",
             "^CORAL" = "no_id",
             "Octocoral" = "no_id",
             "OCTOCORAL" = "no_id")),
         species = str_replace_all(species,                   # fix species spelling errors
           c("annuliris" = "annularis",
             "Cavernosa" = "cavernosa",
             "fasitgiata" = "fastigiata",
             "Intersepta" = "intersepta",
             "spp" = "sp", "SPP" = "sp", "species" = "sp",
             "stokesi$" = "stokesii")))

# Add distance from channel for each permanent site
all_counts <- all_counts %>%
  mutate(dist = ifelse(is.na(dist), case_when(           
    site=="R2N1" ~ "28",
    site=="R2NC2" ~ "9380",
    site=="R2N2" ~ "18",
    site=="R2NC1" ~ "9380",
    site=="R2NC3" ~ "9380",
    site=="R2S1" ~ "23",
    site=="R2SC1" ~ "1270",
    site=="R2S2" ~ "21",
    site=="R2SC2" ~ "1270",
    site=="R3N1" ~ "23",
    site=="R3NC1" ~ "9380",
    site=="R3S2" ~ "21",
    site=="R3SC2" ~ "1300",
    site=="R3S1" ~ "30",       # GET DISTANCE
    site=="R3S3" ~ "30",       # GET DISTANCE
    site=="R3SC3" ~ "1300",      # GET DISTANCE
    site=="R3SC1" ~ "1300"),    # GET DISTANCE
    dist)) %>%
  type_convert()

# remove "tag not found"
all_counts <- filter(all_counts, genus != "Tag")

# Add "site2" (LR or RR) information for permanent sites
all_counts <- all_counts %>%
  mutate(site2 = ifelse(perm == "yes", case_when(
    site %in% c("R2NC2", "R2N1", "R2SC1", "R2S1") ~ "RR",
    site %in% c("R2NC1", "R2NC3", "R2N1", "R2SC2", "R2S2", 
                "R3NC1", "R3N1", "R3SC2", "R2S2",
                "R2N2", "R3S2") ~ "LR",
    site %in% c("R3S1", "R3SC1") ~ "CP",
    site %in% c("R3S3", "R3SC3") ~ "SG"),
    site2))
```

# Save count data as .RData object
```{r}
save(all_counts, file = "data/all_counts.RData")
```

