---
title: "Import and tidy tagged coral data"
author: "Ross Cunning, Rachel Silverstein"
date: "3/07/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

```{r setup2}
# Load packages
library(tidyverse)
library(stringr)
library(lubridate)
library(readxl)

# Function for accessing data for a specific coral from full dataset
getCoral <- function(d, s, t, c) {
  with(d, d[Site==s & Transect==t & Coral.ID==c, ])
}

# Function for accessing corals with specific condition codes
hasCond <- function(cond, Condition.Codes) {
  unlist(lapply(Condition.Codes, FUN=function(x) any(grepl(cond, x))))
}
```

## Import data

### Baseline

##### Hardbottom
```{r baseline_hb}
# Import data from file: Hardbottom_Baseline_POM_050714.xlsx
bl_hb <- readxl::read_xlsx(path = "data/to_analyze/Hardbottom_Baseline_POM_050714.xlsx",
                           sheet = "Raw Data")
# Tidy data
bl_hb <- bl_hb %>%
  clean_names() %>%
  filter(tagged_coral_y_n == "Y") %>%         # Tagged corals only
  rename(site = site_e_g_hbnc1_cp,
         transect = transect_e_g_hbna_1,
         species = subcategory) %>%
  select(date, site, transect, coral_id, species, condition_qa_qc)

# Collapse condition codes to single row
bl_hb <- bl_hb %>%
  group_by(date, site, transect, coral_id, species) %>%
  summarise(condition = list(c(unlist(strsplit(condition_qa_qc, "/"))))) %>%
  ungroup()
```

##### Middle reef
```{r baseline_r2}
# Import data from file: Reef2_Baseline_POM_2013_050714.xlsx
bl_r2 <- readxl::read_xlsx(path = "data/raw/Reef2_Baseline_POM_2013_050714.xlsx",
                           sheet = "Raw Data", guess_max = 3000)

# Tidy data
bl_r2 <- bl_r2 %>%
  clean_names() %>%
  filter(tagged_coral_y_n == "Y") %>%
  rename(site = site_e_g_r2n1_rr,
         transect = transect_e_g_r2n1_rr_1,
         species = subcategory) %>%
  select(date, site, transect, coral_id, species, condition_qa_qc)

# Collapse condition codes to single row
bl_r2 <- bl_r2 %>%
  group_by(date, site, transect, coral_id, species) %>%
  summarise(condition = list(c(unlist(strsplit(condition_qa_qc, "/"))))) %>%
  ungroup()
```

##### Outer reef
```{r baseline_r3}
# Import data from file: Reef2_Baseline_POM_2013_050714.xlsx
bl_r3 <- readxl::read_xlsx(path = "data/raw/Reef3_Baseline_POM_050714 (REVISED DOCUMENT).xlsx",
                           sheet = "Raw Data", guess_max = 3000)

# Tidy data
bl_r3 <- bl_r3 %>%
  clean_names() %>%
  filter(tagged_coral_y_n == "Y") %>%
  rename(site = site_e_g_hbnc1_cp,
         transect = transect_e_g_hbna_1,
         species = subcategory) %>%
  select(date, site, transect, coral_id, species, qa_qc_condition_code)

# Collapse condition codes to single row
bl_r3 <- bl_r3 %>%
  group_by(date, site, transect, coral_id, species) %>%
  summarise(condition = list(c(unlist(strsplit(qa_qc_condition_code, "/"))))) %>%
  ungroup()
```

##### Combine baseline data for HB, R2, R3
```{r baseline_combine}
bl <- bind_rows(bl_hb, bl_r2, bl_r3) %>%
  mutate(date = as_date(date)) %>%
  mutate_at(c("transect", "coral_id"), as.factor)
```

### Compliance monitoring (during construction)

Hardbottom, middle, and outer reef data are all in the same spreadsheet.

```{r load_data_nov2013_mar2015}
# Import data from file: NEW_Offshore_Comp_Scleractinian_Cond_All_Weeks_8_10_15-QAQC.xlsx
comp <- readxl::read_xlsx(
  path = "data/DEP_all/NEW_Offshore_Comp_Scleractinian_Cond_All_Weeks_8_10_15-QAQC.xlsx",
  sheet = "All Weeks", guess_max = 3000)

# Tidy data
comp <- comp %>%
  clean_names() %>%
  select(date, week, site, transect, coral_id, species, condition_code) %>%
  mutate(date = as_date(date)) %>%
  mutate_at(c("transect", "coral_id"), as.factor)

# Correct typos and errors in date column (detected by looking at distinct date/week combinations)
comp <- comp %>%
  # 2014-11-25 should be 2013-11-25 because it is Week #1
  mutate(date = if_else(date == "2014-11-25", as_date("2013-11-25"), as_date(date))) %>%
  # 2013-04-02 should be 2014-04-02
  mutate(date = if_else(date == "2013-04-02", as_date("2014-04-02"), as_date(date))) %>%
  # Looks like a mistake from filling down Date in Excel for Surveyor MLR 
  # Change all Week 27 dates greater than May 23, 2014 to May 23, 2014
  mutate(date = if_else(week == 27 & date > as_date("2014-05-23"),
                        as_date("2014-05-23"), as_date(date))) %>%
  # 2020-05-29 should be 2014-05-29
  mutate(date = if_else(date == "2020-05-29", as_date("2014-05-29"), as_date(date)))

# Aggregate condition codes into single row for each observation
comp <- comp %>%
  group_by(date, site, transect, coral_id, species) %>%
  summarise(condition = list(condition_code)) %>%
  ungroup()
```

### Immediate post-construction

#### April - May 2015
```{r load_data_aprmay2015}
# Import data from file: NEW_Offshore_Compliance_Scleractinian_Cond_R2_R3_IMPACT_ASSESS_data TAGGED CORALS.xlsx
pc1 <- readxl::read_xlsx(
  path = "data/raw/2015data/NEW_Offshore_Compliance_Scleractinian_Cond_R2_R3_IMPACT_ASSESS_data TAGGED CORALS.xlsx",
  sheet = "IA TAGGED ONLY")

# Tidy data
pc1 <- pc1 %>%
  clean_names() %>%
  select(date, site, transect, coral_id, species, condition_code) %>%
  mutate(date = as_date(date)) %>%
  mutate_at(c("transect", "coral_id"), as.factor)

# Aggregate condition codes into single row for each observation
pc1 <- pc1 %>%
  group_by(date, site, transect, coral_id, species) %>%
  summarise(condition = list(condition_code)) %>%
  ungroup()
```

#### June - July 2015
```{r load_data_junjuly2015}
# Import data from file: NEW_Offshore_Post_Construction_Data_Entry_ALL_Weeks_GOOD 151015.xlsx
pc2 <- readxl::read_xlsx(
  path = "data/raw/NEW_Offshore_Post_Construction_Data_Entry_ALL_Weeks_GOOD 151015.xlsx",
  sheet = "Raw Data", guess_max = 3000)

# Tidy data
pc2 <- pc2 %>%
  clean_names() %>%
  filter(tagged_coral_y_n == "Y") %>%           # Tagged corals only
  select(date, site, transect, coral_id, species, condition_code_qaqc) %>%
  mutate(date = as_date(date)) %>%
  mutate_at(c("transect", "coral_id"), as.factor)

# Aggregate condition codes into single row for each observation
pc2 <- pc2 %>%
  group_by(date, site, transect, coral_id, species) %>%
  summarise(condition = list(condition_code_qaqc)) %>%
  ungroup()
```

### One year post-construction (Aug 2016)

```{r load_data_aug2016}
# Import data from file: permanent_sites_impact_assessment_corals_2016_CSI_QAQC.xlsx
pc3 <- readxl::read_xlsx(
  path = "data/raw/permanent_sites_impact_assessment_corals_2016_CSI_QAQC.XLSX",
  sheet = "Raw Data", guess_max = 3000, skip = 1)

# Tidy data
pc3 <- pc3 %>%
  clean_names() %>%
  filter(tagged_coral_y_n == "Y") %>%              # Tagged corals only
  select(date, site, transect, coral_id, species, condition_code_qaqc) %>%
  mutate(date = as_date(date)) %>%
  mutate_at(c("transect", "coral_id"), as.factor)

# Aggregate condition codes into single row for each observation
pc3 <- pc3 %>%
  group_by(date, site, transect, coral_id, species) %>%
  summarise(condition = list(condition_code_qaqc)) %>%
  ungroup()
```

# Combine all tagged coral data
```{r merge_data}
# Combine all data
tagged <- bind_rows(bl, comp, pc1, pc2, pc3) %>%
  mutate_if(is.character, as.factor)
```

# Homogenize site, transect, coral ID, and species levels
```{r}

```


```{r}
# Add grouping factors
alldata$Channel <- ifelse(grepl("C", alldata$Site), "control", "channelside")
alldata$reef <- substr(alldata$Site, 1, 2)
alldata$dir <- substr(alldata$Site, 3, 3)

# Find any remaining species names errors to fix
levels(droplevels(factor(alldata$Species)))
# Coral that was labele MDEC at all other time points was labeled MFOR once
alldata[alldata$Species=="MFOR", "Species"] <- "MDEC"
# Apparently MFER and MALI (Mycetolphyllia ferox vs. aliciae) were both used for some corals, rename to MYCE
alldata[alldata$Species=="MFER", "Species"] <- "MYCE"
alldata[alldata$Species=="MALI", "Species"] <- "MYCE"
alldata[alldata$Species=="Mycetophyllia ferox", "Species"] <- "MYCE"
# Change Orbicella annularis to OANN
alldata[alldata$Species=="Orbicella annularis", "Species"] <- "OANN"
# Change stephanocoenia intersepta to SINT
alldata[alldata$Species=="stephanocoenia intersepta", "Species"] <- "SINT"

# Strip whitespace from condition codes
alldata$Condition.Codes <- lapply(alldata$Condition.Codes, trimws)

# Add column for individual coral unique identifier
alldata$coral <- with(alldata, interaction(Site, Transect, Coral.ID))
alldata <- droplevels(alldata)

# Write all data to spreadsheet (STILL CONTAINS UNCORRECTED SPP CONFLICTS)
dd <- alldata %>% 
  arrange(coral, Date) %>%
  select(-Channel, -reef, -dir, -coral)

dd$Condition.Codes <- vapply(dd$Condition.Codes, paste, collapse = ", ", character(1L))

write.table(dd, file="alldatatable.txt", row.names = FALSE, quote = FALSE, sep = "\t")
```

#### Check for conflicting species assignments for individual corals

```{r check_conflicts}
# How many corals have multiple species assignments? (e.g., indicative of an error in data entry)
spp <- with(alldata, aggregate(Species, by=list(Site=Site, Transect=Transect, Coral.ID=Coral.ID), 
                     FUN=function(x) unique(c(as.character(x)))))
table(sapply(spp$x, length)>1)

capture.output(spp, file="all_spp_conflicts.txt")
```

Out of 115 corals, 23 have multiple species IDs associated with them at different points in time, indicative of some (unidentifiable) error in data entry. These errors might be resolved by going back to the raw data collection sheets.

#### Change conflicting species assignments to reflect most frequently assigned species

We attempt to fix some of these conflicting species assignments by changing species assignments for each coral (defined as unique site-transect-coralID) to the most frequently assigned species.

```{r fix_errors}
# There are several instances where a given Site-Transect-Coral.ID has multiple spp. assignments...
# Find which name was used most frequently for each Site-Transect-Coral.ID
which.spp <- with(alldata, {
  aggregate(data.frame(Species=Species), by=list(Site=Site, Transect=Transect, Coral.ID=Coral.ID), 
            FUN=function(x) {
              names(table(c(as.character(x))))[which.max(table(c(as.character(x))))]
            })
})

# Reassign all values of Species for each coral to the most freq used Species
for (i in 1:nrow(which.spp)) {
  alldata[alldata$Site==which.spp[i, "Site"] & 
          alldata$Transect==which.spp[i, "Transect"] &
          alldata$Coral.ID==which.spp[i, "Coral.ID"],
          "Species"] <- which.spp[i, "Species"]
}
```

#### Identify colonies that died after having WP

```{r}
wpbeforedead <- alldata %>%
  group_by(coral) %>%
  summarise(WP = as.character(min(Date[hasCond("^WP$", Condition.Codes)])),
            DEAD = as.character(min(Date[hasCond("^DEAD$", Condition.Codes)]))) %>%
  drop_na() %>%
  mutate(WPbeforeDEAD = as.Date(WP) < as.Date(DEAD))

# For these corals that had WP before DEAD, change DEAD to WPDEAD
alldata[alldata$coral %in% wpbeforedead$coral & hasCond("DEAD", alldata$Condition.Codes), "Condition.Codes"] <- "WPDEAD"
```

#### Change *A. cervicornis* WP records to WB

```{r}
cond <- alldata[alldata$Species=="ACER" & hasCond("^WP$", alldata$Condition.Codes), "Condition.Codes"]
alldata[alldata$Species=="ACER" & hasCond("^WP$", alldata$Condition.Codes), "Condition.Codes"] <- str_replace_all(cond, "WP", "WB")
```

# Save tagged coral data as .RData
```{r}
save(alldata, file = "data/tagged_corals.RData")
```
