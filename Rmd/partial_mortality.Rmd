---
title: "Partial mortality of corals during PortMiami dredge"
author: "Ross Cunning"
date: "5/23/2018"
output: html_document
editor_options: 
  chunk_output_type: inline
---

# Setup
```{r setup, include = FALSE}
# Set knitr options
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
# Load packages
library(tidyverse)
library(janitor)
library(lubridate)
library(lme4)
library(lsmeans)
library(ggrepel)
library(ggthemes)
```

# Import data
```{r}
# Import tidy tagged coral data (does not include visual estimates of partial mortality extent)
load("data/tagged.RData")
tagged_bool <- tagged_bool %>%
  mutate(day = (date - min(date)) / ddays(1))

# Import 2016 visual estimate of extent of partial mortality data
ia <- read_csv("data/DEP_responsive_records_May_2017/permanent_sites_impact_assessment_corals_2016_CSI_QAQC.csv", skip=1) %>%
  clean_names() %>%
  select("date", "site", "transect", "tagged_coral_y_n", "coral_id", "species", "visual_estimate_percent_mortality") %>%
  filter(tagged_coral_y_n == "Y") %>%
  rename(pct.mort = visual_estimate_percent_mortality) %>%
  mutate(coral = interaction(site, transect, coral_id),
         date = as.Date(date, format = "%m/%d/%y")) %>%
  select("date", "coral", "species", "pct.mort") %>%
  mutate(pct.mort = as.numeric(pct.mort)) %>%
  distinct()  # remove duplicated rows

# Merge percent mortality with rest of data
pmor <- full_join(ia, tagged_bool, by=c("date", "coral", "species"))
pmor <- pmor[!is.na(pmor$channel),]  # A couple of spp IDs didn't match (data entry error?), so other columns did not merge. omit these rows.
```

# Prevalence of partial mortality due to sedimentation

The DCA November 2015 report (page 14) indicates that the "PM" condition code is used to indicate partial mortality associated with sedimentation. Analysis of the prevalence of "PM" codes recorded for all tagged corals will test the hypothesis that corals at channelside sites were more likely to experience partial mortality due to sedimentation than corals at control sites.

First we analyze the accumulation of the PM condition code across tagged corals at all sites. For this analysis, once a coral is recorded as PM, it is counted as PM at all future time points.

```{r}
# Fill in missing observations (if a specific coral was missed on a day) 
tagged_bool_complete <- tagged_bool %>% 
  group_by(site) %>%
  complete(date, coral, fill = list(PM = FALSE)) %>%
  fill(reef, dir, channel) %>%
  ungroup()

# If PM ever observed for a coral, change all future observations of PM to TRUE
cumpm <- tagged_bool_complete %>%
  group_by(coral) %>%
  mutate(PM = ifelse(any(PM) & date > min(date[PM]), TRUE, PM)) %>%
  group_by(date, reef, dir, channel, site) %>%
  summarise(prop = sum(PM) / n())

# Plot cumulative proportion of corals with PM (ever) over time
#ggplot(cumpm, aes(x = date, y = prop)) + 
#  facet_wrap(~ site) +
#  geom_line(aes(color = channel, group = channel)) +
#  labs(title = "Cumulative PM", x = "Time (weeks)", y = "Proportion of corals")

ggplot(cumpm, aes(x = date, y = prop, color = channel, group = site)) + 
  geom_line() +
  labs(title = "Cumulative PM", x = "Date", y = "Proportion of corals") +
  geom_text_repel(data = cumpm %>% group_by(site) %>% filter(date == max(date)),
                  aes(label = site))
```

# Filter dataset
Omit site HBN1, because this site was not monitored during much of the constructioon period because it had been 'buried' by a natural sand wave (DCA). Many of the corals were recorded as BUR before observations of this site ended.
```{r}
tagged_bool <- tagged_bool %>%
  filter(site != "HBN1")                     # Remove site because corals all BUR => no opp for PM?
```

Calculate the total number of corals at each site that experienced partial mortality (up to end of March 2015, last month of dredging), and plot as a barplot.

```{r, fig.width = 10, fig.height = 3}
# Quantify occurrence of PM during compliance and post-con:
pm <- tagged_bool %>%
  #filter(date < "2015-07-31") %>%     
  filter(date <= "2015-03-31") %>%     # Filter up through March 2015 (last month of dredging)
  group_by(reef, dir, channel, site, transect, species, coral) %>%
  summarise(PM = any(PM))

# Summarize proportion of tagged corals at each site that experienced PM
pm.summ <- pm %>%
  group_by(site, channel, reef, dir) %>%
  summarise(n = n(),
            pm = sum(PM),
            prop = pm / n)

ggplot(pm.summ, aes(x = site, y = prop, fill = interaction(reef, dir, channel))) +
  facet_wrap(dir ~ reef, scales = "free_x") +
  geom_bar(stat = "identity")
```

This plot of the proportion of tagged corals at each site show that channelside sites generally showed higher levels of partial mortality. We can test for a statistical effect of location using a generalized linear mixed model.

# Was partial mortality due to sedimentation more common at channelside sites?
```{r}
# Fit generalized linear mixed model
pm.mod1 <- glmer(PM ~ channel * reef * dir + (1|site/transect) + (1|species), 
                 family = "binomial", data = pm)

# Generate lsmeans for each reef/direction/channelside
pm.lsm1 <- lsmeans(pm.mod1, specs = c("channel", "reef", "dir"), type = "response")

# Test channelside vs. control mortality for each reef/direction
pm.lsm1.sig <- rbind(pairs(pm.lsm1, by = c("reef", "dir")), adjust = "none")
knitr::kable(summary(pm.lsm1.sig))

# Plot partial mortality prevalence
ggplot(summary(pm.lsm1), aes(x = channel, y = prob, fill = channel)) + 
  facet_grid(dir ~ reef) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, lwd = 0.3) +
  geom_text(data = data.frame(summary(pm.lsm1.sig)), inherit.aes = FALSE,
            aes(x = 1.5, y = 0.8, label = ifelse(p.value < 0.05, "*", NA)), cex = 10)

save(pm.lsm1, pm.lsm1.sig, file = "data/pm.lsm.RData")
```

**We find a significantly higher probability of partial mortality due to sedimentation for corals at channelside sites relative to controls for the northern middle reef (75% vs. 4%, p < 0.0001), the southern middle reef (61% vs. 16%, p = 0.0003), the southern hardbottom (70% vs. 23%, p = 0.0013), and the southern outer reef (24% vs. 8%, p = 0.0216.**
There was an almost significant difference in probability of partial mortality at the northern outer reef channelside sites (68%) vs. control sites (31%; p = 0.0581).

```{r, fig.height = 3, fig.width = 3}
# Average across all reefs
# Fit generalized linear mixed model
pm.mod2 <- glmer(PM ~ channel + (1|site/transect) + (1|species), family = "binomial", data = pm)

# Generate lsmeans
pm.lsm2 <- lsmeans(pm.mod2, specs = "channel", type = "response")

# Test channelside vs. control
pm.lsm2.sig <- rbind(pairs(pm.lsm2), adjust = "none")
knitr::kable(summary(pm.lsm2.sig))

# Plot partial mortality prevalence
ggplot(summary(pm.lsm2), aes(x = channel, y = prob, fill = channel)) + 
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, lwd = 0.3) +
  geom_text(data = data.frame(summary(pm.lsm2.sig)), inherit.aes = FALSE,
            aes(x = 1.5, y = 0.65, label = ifelse(p.value < 0.05, "*", NA)), cex = 10) +
  theme(legend.position="none")

```

**When all reef locations are analyzed together, partial mortality due to sediment occurred in 57.7% of corals at channelside sites compared to only 11.0% at control sites (p < 0.0001).**

# Visual estimates of tissue loss for each coral

Visual estimates of tissue loss for all tagged corals were made in August 2016. To analyze tissue loss that may be due to dredging sedimentation, we must exclude tissue loss that is more likely attributed to white plague disease. Therefore, the following analyses are performed for only disease-resistant coral species.

```{r, fig.width = 10, fig.height = 3}
# WP disease-susceptible species
sus.spp <- c("CNAT", "DSTO", "DLAB", "EFAS", "MMEA", "MCAV", "ODIF", "DCLI", "DSTR", "SBOU")

# Subset non-disease-susceptible corals
pmor <- filter(pmor, !species %in% sus.spp)  # exclude susceptible corals
```

### Was tissue loss greater for disease-resistant corals at channelside sites?
```{r}
# Fit model
pmor.mod1 <- pmor %>%
  glmer(pct.mort/100 ~ channel * reef * dir + (1|site/transect) + (1|species), 
        data = ., family = "binomial")

# Get lsmeans
pmor.lsm1 <- lsmeans(pmor.mod1, specs = c("channel", "reef", "dir"), type = "response")

# Test channelside vs. control mortality for each reef/direction
pmor.lsm1.sig <- rbind(pairs(pmor.lsm1, by = c("reef", "dir")), adjust = "none")
knitr::kable(summary(pmor.lsm1.sig))

# Plot tissue loss
ggplot(summary(pmor.lsm1), aes(x = channel, y = prob, fill = channel)) + 
  facet_grid(dir ~ reef) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, lwd = 0.3) +
  geom_text(data = data.frame(summary(pmor.lsm1.sig)), inherit.aes = FALSE,
            aes(x = 1.5, y = 0.8, label = ifelse(p.value < 0.05, "*", NA)), cex = 10)
```

**Corals on the northern middle reef (R2 N) showed increased tissue loss at channelside sites (49.3%) relative to control sites (15.2%), p = 0.0250.**

### Individual species at the northern middle reef

The northern middle reef showed higher tissue loss for corals at channelside sites relative to controls. We can see what this looked like for individual species. Note that we are only looking at disease-resistant species.

```{r}
pmor.mod2 <- pmor %>%
  filter(reef == "R2", dir == "N") %>%
  glmer(pct.mort/100 ~ channel * species + (1|site/transect), 
      data = ., family = "binomial")

# Get lsmeans
pmor.lsm2 <- lsmeans(pmor.mod2, specs = c("channel", "species"), type = "response")

# Pairwise comparisons (channelside vs. control) for each species
pmor.lsm2.sig <- rbind(pairs(pmor.lsm2, by = c("species")), adjust = "none")
knitr::kable(summary(pmor.lsm2.sig))

# Plot
ggplot(summary(pmor.lsm2), aes(x = channel, y = prob, fill = channel)) + 
  facet_wrap(~ species) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, lwd = 0.3) +
  geom_text(data = data.frame(summary(pmor.lsm2.sig)), inherit.aes = FALSE,
            aes(x = 1.5, y = 0.9, label = ifelse(p.value < 0.05, "*", NA)), cex = 10)
```

**_Siderastrea siderea_ has significantly higher tissue loss at channelside sites (57.1%) compared to control sites (8.3%) on the northern middle reef.**
For *Stephanocoenia intersepta*, tissue loss is also higher at channelside relative to control sites, but this difference was not significant. For *P. astreoides*, there were no tagged corals at the channelside sites at the northern middle reef.

### Tissue loss in SSID and PAST and SINT across all sites
```{r}
pmor.mod3 <- pmor %>%
  filter(species == "SSID" | species == "PAST" | species == "SINT") %>%
  glmer(pct.mort/100 ~ channel * species + (1|site/transect), 
      data = ., family = "binomial")

# Get lsmeans
pmor.lsm3 <- lsmeans(pmor.mod3, specs = c("species", "channel"), type = "response")

# Pairwise comparisons (channelside vs. control) for each species
pmor.lsm3.sig <- rbind(pairs(pmor.lsm3, by = c("species"), adjust = "none"))
knitr::kable(summary(pmor.lsm3.sig))

# Plot
ggplot(summary(pmor.lsm3), aes(x = channel, y = prob, fill = channel)) + 
  facet_wrap(~ species) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, lwd = 0.3) +
  geom_text(data = data.frame(summary(pmor.lsm3.sig)), inherit.aes = FALSE,
            aes(x = 1.5, y = 0.9, label = ifelse(p.value < 0.05, "*", NA)), cex = 10)
```

*S. siderea* experience on average 44% tissue loss at channelside sites, compared to 12.5% tissue loss at control sites, but this difference was not significant (p = 0.0632).

# Is partial mortality related to amount of fine sediments deposited in an area?
```{r finesed.pm}
# Load sediment deposition data (see Rmd/sediment_trap.Rmd)
load("data/sed_deposited.RData")

# Join partial mortality results with fine sediment deposition data
finesed.pm <- full_join(fine.depo, summary(pm.lsm1))
finesed.pm <- ungroup(finesed.pm)

# Fit linear model with weights inverse to standard error of y-axis
lmod <- lm(prob ~ int_fit, data = finesed.pm, weights = 1 / SE)
lpred <- data.frame(int_fit = finesed.pm$int_fit, prob = predict(lmod, finesed.pm))
summary(lmod)$r.squared
summary(lmod)$coefficients[,4][2]

# Fit a Weibull type 2 curve using 1/SE as weights
nls1 <- nls(prob ~ c + (d - c) * (1 - exp(-exp(b * (log(int_fit) - log(e))))), data = finesed.pm,
            weights = 1 / SE,
            start = list(b = 2.2, c = 0.08, d = 0.8, e = 254))
nls1pred <- data.frame(int_fit = min(finesed.pm$int_fit):max(finesed.pm$int_fit))
nls1pred$prob <-  predict(nls1, newdata = nls1pred)

# Plot
fine <- ggplot(finesed.pm, aes(x = int_fit, y = prob)) + 
  geom_errorbar(aes(ymin = prob - SE, ymax = prob + SE), lwd = 0.2) +
  geom_errorbarh(aes(xmin = int_min, xmax = int_max), lwd = 0.2) +
  geom_point() +
  geom_line(data = nls1pred, linetype = 2) +
  #geom_line(data = lpred, linetype = 2) +
  #geom_smooth(method='lm') +
  labs(x = "Total fine sediment deposited (g)",
       y = "Probability of partial mortality to coral",
       title = "Fine sediments") +
  geom_text_repel(aes(label = paste(reef, dir, channel)), size = 2.5) +
  #annotate("text", x = 350, y = 0.1, label = as.character(expression(R^{2}*" = 0.74")), parse = TRUE) +
  #annotate("text", x = 350, y = 0.05, label = "p = 0.0003") +
  theme_few()
fine
```

# Is partial mortality related to amount of coarse sediments deposited in an area?
```{r coarsesed.pm}
# Join partial mortality results with coarse sediment deposition data
coarsesed.pm <- full_join(coarse.depo, summary(pm.lsm1))
coarsesed.pm <- ungroup(coarsesed.pm)


# Fit linear model with weights inverse to standard error of y-axis
lmod <- lm(prob ~ log(int_fit), data = coarsesed.pm, weights = 1 / SE)
lpred <- data.frame(int_fit = coarsesed.pm $int_fit, prob = predict(lmod, coarsesed.pm))
summary(lmod)$r.squared
summary(lmod)$coefficients[,4][2]

#drm1 <- drm(prob ~ int_fit, data = coarsesed.pm, fct = W2.4())
#drm1
#plot(drm1)

# Fit a Weibull type 2 curve using 1/SE as weights
nls1 <- nls(prob ~ c + (d - c) * (1 - exp(-exp(b * (log(int_fit) - log(e))))), data = coarsesed.pm,
            weights = 1 / SE,
            start = list(b = 2.3, c = 0.09, d = 0.7, e = 129))
nls1pred <- data.frame(int_fit = min(coarsesed.pm$int_fit):max(coarsesed.pm$int_fit))
nls1pred$prob <-  predict(nls1, newdata = nls1pred)

# Plot
coarse <- ggplot(coarsesed.pm, aes(x = int_fit, y = prob)) + 
  geom_errorbar(aes(ymin = prob - SE, ymax = prob + SE), lwd = 0.2) +
  geom_errorbarh(aes(xmin = int_min, xmax = int_max), lwd = 0.2) +
  geom_point() +
  geom_line(data = lpred, linetype = 1) +
  #geom_smooth(method='lm') +
  labs(x = "Total coarse sediment deposited (g)",
       y = "Probability of partial mortality to coral",
       title = "Coarse sediments") +
  geom_text_repel(aes(label = paste(reef, dir, channel)), size = 2.5) +
  #annotate("text", x = 750, y = 0.1, label = as.character(expression(R^{2}*" = 0.28")), parse = TRUE) +
  #annotate("text", x = 750, y = 0.05, label = "p = 0.079") +
  theme_few()
coarse
```

# Is partial mortality related to amount of ALL sediments deposited in an area?
```{r totsed.pm}
# Join partial mortality results with total sediment deposition data
totsed.pm <- full_join(total.depo, summary(pm.lsm1))
totsed.pm <- ungroup(totsed.pm)

# Fit linear model with weights inverse to standard error of y-axis
lmod <- lm(prob ~ log(int_fit), data = totsed.pm , weights = 1 / SE)
lpred <- data.frame(int_fit = totsed.pm $int_fit, prob = predict(lmod, totsed.pm ))
summary(lmod)$r.squared
summary(lmod)$coefficients[,4][2]

#drm1 <- drm(prob ~ int_fit, data = bb, fct = W2.4())
#drm1
#plot(drm1)

# Fit a Weibull type 2 curve using 1/SE as weights
nls1 <- nls(prob ~ c + (d - c) * (1 - exp(-exp(b * (log(int_fit) - log(e))))), data = totsed.pm ,
            weights = 1 / SE,
            start = list(b = 2.6, c = 0.13, d = 0.6, e = 242))
nls1pred <- data.frame(int_fit = min(totsed.pm $int_fit):max(totsed.pm $int_fit))
nls1pred$prob <-  predict(nls1, newdata = nls1pred)

# Plot
total <- ggplot(totsed.pm , aes(x = int_fit, y = prob)) + 
  geom_errorbar(aes(ymin = prob - SE, ymax = prob + SE), lwd = 0.2) +
  geom_errorbarh(aes(xmin = int_min, xmax = int_max), lwd = 0.2) +
  geom_point() +
  geom_line(data = lpred, linetype = 1) +
  labs(x = "Total ALL sediment deposited (g)",
       y = "Probability of partial mortality to coral",
       title = "All sediments") +
  geom_text_repel(aes(label = paste(reef, dir, channel)), size = 2.5) +
  theme_few()
total
```