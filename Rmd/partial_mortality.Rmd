---
title: "Partial mortality of corals during PortMiami dredge"
author: "Ross Cunning"
date: "5/23/2018"
output: html_document
editor_options: 
  chunk_output_type: inline
---

# Setup
```{r setup, include = FALSE}
# Set knitr options
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
# Load packages
library(tidyverse)
library(lme4)
library(lsmeans)

# Define function for accessing corals with specific condition codes
hasCond <- function(cond, Condition.Codes) {
  unlist(lapply(Condition.Codes, FUN=function(x) any(grepl(cond, x))))
}
```

# Import data
```{r}
# Import tidy tagged coral data (does not include visual estimates of partial mortality extent)
load("../data/tagged_corals.RData")

# Import 2016 visual estimate of extent of partial mortality data
ia <- read_csv("../data/DEP_responsive_records_May_2017/permanent_sites_impact_assessment_corals_2016_CSI_QAQC.csv", skip=1) %>%
  select("Date", "Site", "Transect", "Tagged coral (Y/N)", "Coral ID", "Species", "Visual Estimate % Mortality") %>%
  filter(`Tagged coral (Y/N)` == "Y") %>%
  rename("pct.mort" = "Visual Estimate % Mortality") %>%
  mutate(coral = interaction(Site, Transect, `Coral ID`),
         Date = as.Date(Date, format = "%m/%d/%y")) %>%
  select("Date", "coral", "Species", "pct.mort") %>%
  filter(grepl("^R", coral)) %>%
  mutate(pct.mort = as.numeric(pct.mort)) %>%
  distinct()  # remove duplicated rows


# Merge percent mortality with rest of data
pmor <- left_join(ia, alldata, by=c("Date", "coral", "Species")) %>%
  select(Date, reef, dir, Site, Channel, Transect, Coral.ID, Species, pct.mort, coral)
pmor <- pmor[!is.na(pmor$Channel),]  # A couple of spp IDs didn't match (data entry error?), so other columns did not merge. omit these rows.
```

# Prevalence of partial mortality due to sedimentation

The DCA November 2015 report (page 14) indicates that the "PM" condition code is used to indicate partial mortality associated with sedimentation. Analysis of the prevalence of "PM" codes recorded for all tagged corals will test the hypothesis that corals at channelside sites were more likely to experience partial mortality due to sedimentation than corals at control sites.

```{r, fig.width = 10, fig.height = 3}
# Quantify occurrence of PM during compliance and post-con:
pm <- alldata %>%
  filter(Date < "2015-07-31") %>%     # Filter up to July 2015 (post-construction monitoring)
  group_by(reef, dir, Channel, Site, Transect, Species, coral) %>%
  summarise(PM = any(hasCond("^PM$", Condition.Codes)))

# Summarize proportion of tagged corals at each site that experienced PM
pm.summ <- pm %>%
  group_by(Site, Channel, reef, dir) %>%
  summarise(n = n(),
            pm = sum(PM),
            prop = pm / n)

knitr::kable(pm.summ)

ggplot(pm.summ, aes(x = Site, y = prop, fill = interaction(reef, dir, Channel))) +
  facet_grid(~ reef + dir, scales = "free_x") +
  geom_bar(stat = "identity")
```

This plot of the proportion of tagged corals at each site show that channelside sites generally showed higher levels of partial mortality. We can test for a statistical effect of location using a generalized linear mixed model.

# Was partial mortality due to sedimentation more common at channelside sites?
```{r}
# Fit generalized linear mixed model
pm.mod1 <- glmer(PM ~ Channel * reef * dir + (1|Site) + (1|Species), family = "binomial", data = pm)

# Generate lsmeans for each reef/direction/channelside
pm.lsm1 <- lsmeans(pm.mod1, specs = c("Channel", "reef", "dir"), type = "response")

# Test channelside vs. control mortality for each reef/direction
pm.lsm1.sig <- rbind(pairs(pm.lsm1, by = c("reef", "dir")), adjust = "none")
knitr::kable(summary(pm.lsm1.sig))

# Plot partial mortality prevalence
ggplot(summary(pm.lsm1), aes(x = Channel, y = prob, fill = Channel)) + 
  facet_grid(dir ~ reef) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, lwd = 0.3) +
  geom_text(data = data.frame(summary(pm.lsm1.sig)), inherit.aes = FALSE,
            aes(x = 1.5, y = 0.8, label = ifelse(p.value < 0.05, "*", NA)), cex = 10)
```

**We find a significantly higher probability of partial mortality due to sedimentation for corals at channelside sites relative to controls for the northern middle reef (77% vs. 4%), the southern middle reef (62% vs. 19%), and the southern outer reef (26% vs. 9%).**
There was no difference in partial mortality for corals at northern outer reef channelside and controls.

```{r, fig.height = 3, fig.width = 3}
# Average across all reefs
# Fit generalized linear mixed model
pm.mod2 <- glmer(PM ~ Channel + (1|Site) + (1|Species), family = "binomial", data = pm)

# Generate lsmeans
pm.lsm2 <- lsmeans(pm.mod1, specs = "Channel", type = "response")

# Test channelside vs. control
pm.lsm2.sig <- rbind(pairs(pm.lsm2), adjust = "none")
knitr::kable(summary(pm.lsm2.sig))

# Plot partial mortality prevalence
ggplot(summary(pm.lsm2), aes(x = Channel, y = prob, fill = Channel)) + 
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, lwd = 0.3) +
  geom_text(data = data.frame(summary(pm.lsm2.sig)), inherit.aes = FALSE,
            aes(x = 1.5, y = 0.65, label = ifelse(p.value < 0.05, "*", NA)), cex = 10) +
  theme(legend.position="none")

```

**When all reef locations are analyzed together, partial mortality due to sediment occurred in 53% of corals at channelside sites compared to only 10% at control sites (p = 0.0001).**

# Visual estimates of tissue loss for each coral

Visual estimates of tissue loss for all tagged corals were made in August 2016. To analyze tissue loss that may be due to dredging sedimentation, we must exclude tissue loss that is more likely attributed to white plague disease. Therefore, the following analyses are performed for only disease-resistant coral species.

```{r, fig.width = 10, fig.height = 3}
# WP disease-susceptible species
sus.spp <- c("CNAT", "DSTO", "DLAB", "EFAS", "MMEA", "MCAV", "ODIF", "DCLI", "DSTR", "SBOU")

# Subset non-disease-susceptible corals
pmor <- filter(pmor, !Species %in% sus.spp)  # exclude susceptible corals
```

### Was tissue loss greater for corals at channelside sites?
```{r}
# Fit model
pmor.mod1 <- pmor %>%
  glm(pct.mort/100 ~ Channel * reef * dir, data = ., family = "quasibinomial")

# Get lsmeans
pmor.lsm1 <- lsmeans(pmor.mod1, specs = c("Channel", "reef", "dir"), type = "response")

# Test channelside vs. control mortality for each reef/direction
pmor.lsm1.sig <- rbind(pairs(pmor.lsm1, by = c("reef", "dir")), adjust = "none")
knitr::kable(summary(pmor.lsm1.sig))

# Plot tissue loss
ggplot(summary(pmor.lsm1), aes(x = Channel, y = prob, fill = Channel)) + 
  facet_grid(dir ~ reef) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, lwd = 0.3) +
  geom_text(data = data.frame(summary(pmor.lsm1.sig)), inherit.aes = FALSE,
            aes(x = 1.5, y = 0.6, label = ifelse(p.value < 0.05, "*", NA)), cex = 10)
```

**Corals on the northern middle reef (R2 N) showed increased tissue loss at channelside sites (48.3%) relative to control sites (17.5%).**
There was also a significant difference for the southern middle reef, but control sites had higher tissue loss (35.8%) than the channelside sites (8.5%).

### Individual species at the northern middle reef

The northern middle reef showed higher tissue loss for corals at channelside sites relative to controls. We can see what this looked like for individual species. Note that we are only looking at disease-resistant species.

```{r}
pmor.mod2 <- pmor %>%
  filter(reef == "R2", dir == "N") %>%
  glm(pct.mort/100 ~ Channel * Species, data = ., family = "quasibinomial")

# Get lsmeans
pmor.lsm2 <- lsmeans(pmor.mod2, specs = c("Channel", "Species"), type = "response")

# Pairwise comparisons (channelside vs. control) for each species
pmor.lsm2.sig <- rbind(pairs(pmor.lsm2, by = c("Species")), adjust = "none")
knitr::kable(summary(pmor.lsm2.sig))

# Plot
ggplot(summary(pmor.lsm2), aes(x = Channel, y = prob, fill = Channel)) + 
  facet_wrap(~Species) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, lwd = 0.3) +
  geom_text(data = data.frame(summary(pmor.lsm2.sig)), inherit.aes = FALSE,
            aes(x = 1.5, y = 0.75, label = ifelse(p.value < 0.05, "*", NA)), cex = 10)
```

**_Siderastrea siderea_ has significantly higher tissue loss at channelside sites (53.6%) compared to control sites (8.3%) on the northern middle reef.**
For *Stephanocoenia intersepta*, tissue loss is also higher at channelside relative to control sites (41.0% vs. 7.5%), but this difference was not significant. For *P. astreoides*, there were no tagged corals at the channelside sites at the northern middle reef.

