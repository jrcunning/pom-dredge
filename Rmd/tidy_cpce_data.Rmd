---
title: "Import and tidy CPCe data"
author: "Ross Cunning"
date: "6/3/2018"
output: html_document
---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = normalizePath(".."))

# Load packages
library(tidyverse)
library(stringr)
library(lubridate)
library(readxl)
library(janitor)
```

# Import data

Data sheets include percentages of each category in each frame. Multiply these by number of points (excluding tape, wand, and shadow) per frame to get number of points of each category.

```{r}
# Find all file names ending in .xlsx 
files <- list.files(path = "data/CPCe", pattern = "^[^~].*.xlsx", 
                    recursive = TRUE, full.names = TRUE)

# Import and tidy data from each file
cpce <- data_frame(file = files) %>%
  # Extract original DCA CPCe data filepath from cell B4
  mutate(DCAfile = as.character(map(file, readxl::read_xlsx,      
                   sheet = "Data Summary", range = "B4", col_names = FALSE))) %>%
  # Read in data from rows 6 to 23 -- contains percent of each category for each frame
  mutate(data = map(file, readxl::read_xlsx, 
                    sheet = "Data Summary", range = cell_rows(6:23))) %>%
  # Transpose data so each category is a column, each frame a row
  mutate(data = map(data, ~ as_tibble(t(.)))) %>%
  # Set first row of transposed data to column names
  mutate(data = map(data, function(x) rename_at(x, vars(names(x)), funs(slice(x, 1))))) %>%
  # Remove first row (old column names)
  mutate(data = map(data, ~ slice(., -1))) %>%
  # Clean column names
  mutate(data = map(data, ~ janitor::clean_names(.))) %>%
  # Remove rows at end that summarize frames (has NA for number_of_frames)
  mutate(data = map(data, ~ filter(., !is.na(number_of_frames)))) %>%
  # Remove unneeded columns
  mutate(data = map(data, ~ select(., -c(1, 2, 4)))) %>%
  # Convert all columns to numeric
  mutate(data = map(data, ~ mutate_all(., funs(as.numeric)))) %>%
  # Convert all category colummns from percent to number of points of each category
  mutate(data = map(data, ~ mutate_at(., -1, funs(./100 * total_points_minus_tape_wand_shadow)))) %>%
  # Round all numbers to nearest whole number (some slightly different due to DCA rounding)
  mutate(data = map(data, ~ mutate_all(., funs(round)))) %>%
  # Convert all columns to integer
  mutate(data = map(data, ~ mutate_all(., funs(as.integer)))) %>%
  # Remove first column (total number of points column) - all columns are now categories
  mutate(data = map(data, ~ select(., -1)))
```

# Add additional metadata (site and date)

Use information contained within the filenames to get site and date.

```{r}
# Add site, week, transect information
cpce <- cpce %>%
  mutate(basename = tools::file_path_sans_ext(basename(file))) %>%
  mutate(basename = gsub("CPCe.", "", basename)) %>%
  mutate(basename = gsub("-RR", "", basename)) %>%
  mutate(basename = gsub("-LR", "", basename)) %>%
  separate(basename, into = c("site", "week", "transect"), sep = "\ |_|-") %>%
  #mutate(weekn = str_extract(week, "[[:digit:]]{1,2}")) %>%
  mutate(reef = str_sub(site, 1, 2),
         dir  = str_sub(site, 3, 3),
         channel = if_else(grepl("C", site), "control", "channelside"))

# Add date information
# Use information from "POM PERM SITE INVENTORY (5 29 18).xlsx" to add date information
# These are estimates of dates... actual dates may be in "Appendix H"
# Add estimated dates first...
cpce <- cpce %>%
  mutate(date = case_when(
    str_detect(week, "B") ~ case_when(site == "HBN1" ~ as_date("2013-11-07"),
                                      site == "HBN2" ~ as_date("2013-11-07"),
                                      site == "HBN3" ~ as_date("2013-11-07"),
                                      site == "HBNC1" ~ as_date("2013-11-12"),
                                      site == "HBS1" ~ as_date("2013-11-07"),
                                      site == "HBS2" ~ as_date("2013-11-07"),
                                      site == "HBS3" ~ as_date("2013-11-12"),
                                      site == "HBS4" ~ as_date("2013-11-08"),
                                      site == "HBSC1" ~ as_date("2013-11-07"),
                                      site == "R2N1" ~ as_date("2013-11-19"),
                                      site == "R2S1" ~ as_date("2013-11-19"),
                                      site == "R2SC1" ~ as_date("2013-11-18"),
                                      site == "R2NC1" ~ as_date("2013-11-24"),
                                      site == "R2N2" ~ as_date("2013-12-15"),
                                      site == "R2NC2" ~ as_date("2013-12-02"),
                                      site == "R2NC3" ~ as_date("2013-12-10"),
                                      site == "R2S2" ~ as_date("2013-12-15"),
                                      # BL report Table 1 conflicts with Monitoring Matrix for R2SC2
                                      # latest tagged coral data are from 2013-12-15
                                      site == "R2SC2" ~ as_date("2013-12-15"),
                                      # BL report Table 1 conflicts with Monitoring Matrix for R3N1
                                      # latest tagged coral data are from 2013-12-11
                                      site == "R3N1" ~ as_date("2013-12-11"),
                                      site == "R3NC1" ~ as_date("2013-12-10"),
                                      site == "R3S1" ~ as_date("2013-12-30"),
                                      site == "R3S2" ~ as_date("2013-12-30"),
                                      site == "R3S3" ~ as_date("2013-12-30"),
                                      site == "R3SC1" ~ as_date("2013-12-12"),
                                      site == "R3SC2" ~ as_date("2013-12-12"),
                                      site == "R3SC3" ~ as_date("2013-12-12")),
    # Compliance weeks are the same for all reefs, number of weeks since 2013-11-20
    grepl("^C", week) ~ as.Date("2013-11-20") + 
      dweeks(as.numeric(str_extract(week, "[[:digit:]]{1,2}"))),
    # Postconstruction weeks
    week == "PC3" ~ as.Date("2015-07-01"),
    # Impact assessment
    week == "IA" ~ as.Date("2016-08-20")     ### THESE DATES NEED CONFIRMATION
  ))

# Check to see if dates of cpce surveys can be found in DCA filepath
bb <- unlist(str_extract_all(cpce$DCAfile, "[0-9]+-[0-9]+-[0-9]+"))
bb
# only a few files actually have dates......

```

# Additional QC

Categories were not all the same for all CPCe analyses. In some of the analyses, "Sand, Pavement, Rubble (SPR)" was used instead of using separate categories for "Sand" and "Rubble". In these cases, we could assume all SPR is sand, or we could exclude these timepoints altogether.

One frame (R3SC2 IA T2 frame 9) contained no data -- drop from dataset.

```{r}
# Count all records of spr as sand
cpce_spr_as_sand <- cpce %>%
  unnest(data) %>%
  mutate( sand_sa = as.integer(rowSums(select(., sand_sa, sand_pavement_rubble_spr), na.rm = TRUE)),
         rubble_r = as.integer(pmax(rubble_r, 0, na.rm = TRUE))) %>%
  select(-sand_pavement_rubble_spr, -tape_wand_shadow_tws) %>%
  drop_na()   # single row (frame) contained no data -- drop

# Omit all frames for which sand was not an explicit category
cpce_omit_nosand <- cpce %>%
  unnest(data) %>%
  filter(!is.na(sand_sa)) %>%
  select(-sand_pavement_rubble_spr, -tape_wand_shadow_tws) %>%
  drop_na()   # single row (frame) contained no data -- drop
```

# Save both versions of CPCe data as .RData objects
```{r}
save(cpce_spr_as_sand, file = "data/cpce_spr_as_sand.RData")
save(cpce_omit_nosand, file = "data/cpce_omit_nosand.RData")
```


