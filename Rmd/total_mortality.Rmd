---
title: "total_mortality.Rmd"
author: "Ross Cunning"
date: "5/22/2018"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
# Set knitr options
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Load packages
library(tidyverse)
library(lme4)
library(lsmeans)

# Define function for accessing corals with specific condition codes
hasCond <- function(cond, Condition.Codes) {
  unlist(lapply(Condition.Codes, FUN=function(x) any(grepl(cond, x))))
}
```

# Import data
```{r}
# Import tidy tagged coral data
load("../data/tagged_corals.RData")
```

# Analyze mortality
```{r}
# Summarize proportion of corals at each site that died at any point (total mortality)
alldata %>%
  group_by(Site, Channel, reef, coral) %>%
  summarise(DEAD = any(hasCond("DEAD", Condition.Codes))) %>%
  group_by(Site, Channel, reef) %>%
  summarise(n = n(),
            dead = sum(DEAD),
            prop = dead / n)
```

# Test if channelside vs. control sites have different rates of total mortality
```{r}
# Get data frame for each coral and whether it died or not
dead <- alldata %>%
  group_by(reef, dir, Channel, Site, Transect, Species, coral) %>%
  summarise(DEAD = any(hasCond("DEAD", Condition.Codes)))

# Fit generalized linear mixed model
dead.mod1 <- glmer(DEAD ~ Channel * reef * dir + (1|Site), family = "binomial", data = dead)

# Generate lsmeans for each reef/direction/channelside
dead.lsm1 <- lsmeans(dead.mod1, specs = c("Channel", "reef", "dir"), type = "response")

# Test channelside vs. control mortality for each reef/direction
sig <- rbind(pairs(dead.lsm1, by = c("reef", "dir")), adjust = "none")
sig

# Plot mortality rates
ggplot(summary(dead.lsm1), aes(x = Channel, y = prob, fill = Channel)) + 
  facet_grid(dir ~ reef) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, lwd = 0.3) +
  geom_text(data = data.frame(summary(sig)), inherit.aes = FALSE,
            aes(x = 1.5, y = 0.5, label = ifelse(p.value < 0.05, "*", NA)), cex = 10)
```

There is significantly higher mortality at channelside sites relative to control sites for Reef 2 North. However, this does not account for differences in species composition -- the higher mortality at channelside sites could be due to a higher relative abundance of disease-susceptible corals at channelside sites. We can address this by fitting a model the includes coral species as a predictor, but there are too few tagged corals of any individual species to detect any statistically significant differences. We can pool all disease-susceptible vs. non-susceptible corals to carry out this test with higher numbers of corals.

# Tally susceptible and non-susceptible species
```{r}
# WP disease-susceptible species
sus.spp <- c("CNAT", "DSTO", "DLAB", "EFAS", "MMEA", "MCAV", "ODIF", "DCLI", "DSTR", "SBOU")

# Add grouping factor for susceptibility
dead <- mutate(dead, sus = factor(ifelse(Species %in% sus.spp, "sus", "nonsus")))

# Count number of susceptible and non-susceptible corals at each site
dead %>%
  group_by(reef, dir, Channel, sus) %>%
  summarise(n = n()) %>%
  spread(sus, n)
```

Reef 2 north does have a high number of susceptible species, so this needs to be accounted for in the model.

# Re-fit model accounting for composition of susceptible vs. non-susceptible corals
```{r}
# Fit generalized linear mixed model with susceptibility as a covariate
dead.mod2 <- glmer(DEAD ~ Channel * reef * dir * sus + (1|Site), family = "binomial", data = dead)

# Generate lsmeans for each reef/direction/channelside
dead.lsm2 <- lsmeans(dead.mod2, specs = c("Channel", "reef", "dir", "sus"), type = "response")

# Test channelside vs. control mortality for each reef/direction
rbind(pairs(dead.lsm2, by = c("reef", "dir", "sus")), adjust = "none")
```

No significant differences between channelside and control sites are detected for non-susceptible corals at either reef in either direction, although it is almost significant for reef 2 north. This could be due to low statistical power. We can increase power by combining reef 2 and reef 3 sites and looking at all north sites and only south sites. There is evidence that the south control sites were heavily impacted by dredging, so the north direction may be the best place to look for a potential effect.

# Re-fit model combining Reef 2 and Reef 3 for higher replication
```{r}
# Fit glmer with channelside and direction and disease-susceptibility as factors
dead.mod3 <- glmer(DEAD ~ Channel * dir * sus + (1|Site), data = dead, family = "binomial")

# Generate lsmeans
dead.lsm3 <- lsmeans(dead.mod3, specs = c("Channel", "sus", "dir"), type = "response")

# Test channelside vs. control mortality for each direction
sig <- rbind(pairs(dead.lsm3, by = c("dir", "sus")), adjust = "none")
sig

# Plot mortality rates
ggplot(summary(dead.lsm3), aes(x = Channel, y = prob, fill = Channel)) + 
  facet_grid(dir ~ sus) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, lwd = 0.3) +
  geom_text(data = data.frame(summary(sig)), inherit.aes = FALSE,
            aes(x = 1.5, y = 0.65, label = ifelse(p.value < 0.05, "*", NA)), cex = 10)
```

**For non-disease-susceptible corals north of the channel, there is significantly higher mortality (20.5%) at channelside sites relative to controls (3%). This can be considered a permanent impact of dredging.**
There are no differences between channelside and control sites for non-susceptible corals to the south of the channel, and there are no differences for disease-susceptible corals (higher mortality rates overall at all sites due to disease).
