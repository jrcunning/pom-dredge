---
title: "Total mortality of coral colonies during PortMiami dredge"
author: "Ross Cunning"
date: "5/22/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Setup
```{r setup, include=FALSE}
# Set knitr options
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r setup2}
# Load packages
library(tidyverse)
library(lme4)
library(lsmeans)
library(ggrepel)
library(ggthemes)
```

# Import data
```{r}
# Import tidy tagged coral data
load("data/tagged.RData")

# Omit HBN1
tagged_bool <- tagged_bool %>%
  filter(site != "HBN1")
```

# Prevalence of total colony mortality

Total colony mortality was recorded using the condition code "DEAD". Here, we summarize the number of corals at each site that died at any point.

```{r, fig.width = 10, fig.height = 3}
dead.summ <- tagged_bool %>%
  group_by(site, channel, reef, dir, coral) %>%
  summarise(DEAD = any(DEAD)) %>%
  group_by(site, channel, reef, dir) %>%
  summarise(n = n(),
            dead = sum(DEAD),
            prop = dead / n)

knitr::kable(dead.summ)

ggplot(dead.summ, aes(x = site, y = prop, fill = interaction(reef, dir, channel))) +
  facet_wrap(dir ~ reef, scales = "free_x") +
  geom_bar(stat = "identity")
```

# Was total mortality more common at channelside sites?
```{r}
# Get data frame for each coral and whether it died or not
dead <- tagged_bool %>%
  group_by(reef, dir, channel, site, transect, species, coral) %>%
  summarise(DEAD = any(DEAD))

# Fit generalized linear mixed model
dead.mod1 <- glmer(DEAD ~ channel * reef * dir + (1|site/transect) + (1|species), 
                   family = "binomial", data = dead)

# Generate lsmeans for each reef/direction/channelside
dead.lsm1 <- lsmeans(dead.mod1, specs = c("channel", "reef", "dir"), type = "response")

# Test channelside vs. control mortality for each reef/direction
dead.lsm1.sig <- rbind(pairs(dead.lsm1, by = c("reef", "dir")), adjust = "none")
knitr::kable(summary(dead.lsm1.sig))

# Plot mortality rates
ggplot(summary(dead.lsm1), aes(x = channel, y = prob, fill = channel)) + 
  facet_grid(dir ~ reef) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, lwd = 0.3) +
  geom_text(data = data.frame(summary(dead.lsm1.sig)), inherit.aes = FALSE,
            aes(x = 1.5, y = 0.5, label = ifelse(p.value < 0.05, "*", NA)), cex = 10)
```

There are no differences in total colony mortality between channelside and control sites at any reef location. However, total mortality overall is high, and the majority of this mortality may be attributable to white plague disease. Therefore, to assess mortality that may be associated with sedimentation, it may be more informative to analyze only disease-resistant corals.

# Total mortality of disease-resistant corals 
```{r}
# WP disease-susceptible species
sus.spp <- c("CNAT", "DSTO", "DLAB", "EFAS", "MMEA", "MCAV", "ODIF", "DCLI", "DSTR", "SBOU")

# Subset only disease-resistant corals
dead.nonsus <- filter(dead, !species %in% sus.spp)
dead.nonsus %>% ungroup() %>% distinct(species)
dead.nonsus %>% group_by(reef, dir, channel) %>% count(DEAD)

# Fit generalized linear mixed model for disease-resistant corals
dead.mod4 <- glmer(DEAD ~ channel * reef * dir + (1|site/transect) + (1|species), 
                   family = "binomial", data = dead.nonsus)

# Generate lsmeans for each reef and direction
dead.lsm4 <- lsmeans(dead.mod4, specs = c("channel", "reef", "dir"), type = "response")

# Test for differences in mortality at channelside vs. control sites
dead.lsm4.sig <- rbind(pairs(dead.lsm4, by = c("reef", "dir")), adjust = "none")
knitr::kable(summary(dead.lsm4.sig))

# Save lsmeans and sig tests as RData
save(dead.lsm4, dead.lsm4.sig, file = "data/tm.lsm.RData")

# Plot
ggplot(summary(dead.lsm4), aes(x = channel, y = prob, fill = channel)) + 
  facet_grid(dir ~ reef) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, lwd = 0.3) +
  geom_text(data = data.frame(summary(dead.lsm4.sig)), inherit.aes = FALSE,
            aes(x = 1.5, y = 0.9, label = ifelse(p.value < 0.05, "*", NA)), cex = 10)
```

**For disease-resistant corals, there was significantly higher total mortality at channelside sites (57%) relative to control sites (13%) on the northern middle reef.** For the southern middle reef and the outer reef, there was no significant difference in total mortality of disease-resistant corals detected between channelside and control sites.

# Is total mortality related to amount of fine sediments deposited in an area?
```{r finesed.pm}
# Load sediment deposition data (see Rmd/sediment_trap.Rmd)
load("data/sed_deposited.RData")

# Join total mortality results with fine sediment deposition data
finesed.tm <- full_join(fine.depo, summary(dead.lsm4))
finesed.tm <- ungroup(finesed.tm)

# Fit linear model with weights inverse to standard error of y-axis
lmod <- lm(prob ~ int_fit, data = finesed.tm, weights = 1 / SE)
lpred <- data.frame(int_fit = finesed.tm$int_fit, prob = predict(lmod, finesed.tm))
summary(lmod)$r.squared
summary(lmod)$coefficients[,4][2]

# Plot
fine <- ggplot(finesed.tm, aes(x = int_fit, y = prob)) + 
  geom_errorbar(aes(ymin = prob - SE, ymax = prob + SE), lwd = 0.2) +
  geom_errorbarh(aes(xmin = int_min, xmax = int_max), lwd = 0.2) +
  geom_point() +
  #geom_line(data = nls1pred, linetype = 2) +
  #geom_line(data = lpred, linetype = 2) +
  #geom_smooth(method='lm') +
  labs(x = "Total fine sediment deposited (g)",
       y = "Probability of total mortality to coral",
       title = "Fine sediments") +
  geom_text_repel(aes(label = paste(reef, dir, channel)), size = 2.5) +
  #annotate("text", x = 350, y = 0.1, label = as.character(expression(R^{2}*" = 0.74")), parse = TRUE) +
  #annotate("text", x = 350, y = 0.05, label = "p = 0.0003") +
  theme_few()
fine
```

# Is total mortality related to amount of coarse sediments deposited in an area?
```{r coarsesed.pm}
# Join total mortality results with coarse sediment deposition data
coarsesed.tm <- full_join(coarse.depo, summary(dead.lsm4))
coarsesed.tm <- ungroup(coarsesed.tm)


# Fit linear model with weights inverse to standard error of y-axis
lmod <- lm(prob ~ int_fit, data = coarsesed.tm)
lpred <- data.frame(int_fit = coarsesed.tm$int_fit, prob = predict(lmod, coarsesed.tm))
summary(lmod)$r.squared
summary(lmod)$coefficients[,4][2]

# Plot
coarse <- ggplot(coarsesed.tm, aes(x = int_fit, y = prob)) + 
  geom_errorbar(aes(ymin = prob - SE, ymax = prob + SE), lwd = 0.2) +
  geom_errorbarh(aes(xmin = int_min, xmax = int_max), lwd = 0.2) +
  geom_point() +
  #geom_line(data = lpred, linetype = 1) +
  #geom_smooth(method='lm') +
  labs(x = "Total coarse sediment deposited (g)",
       y = "Probability of total mortality",
       title = "Coarse sediments") +
  geom_text_repel(aes(label = paste(reef, dir, channel)), size = 2.5) +
  #annotate("text", x = 750, y = 0.1, label = as.character(expression(R^{2}*" = 0.28")), parse = TRUE) +
  #annotate("text", x = 750, y = 0.05, label = "p = 0.079") +
  theme_few()
coarse
```

# Is total mortality related to amount of ALL sediments deposited in an area?
```{r totsed.pm}
# Join total mortality results with total sediment deposition data
totsed.tm <- full_join(total.depo, summary(dead.lsm4))
totsed.tm <- ungroup(totsed.tm)

# Fit linear model with weights inverse to standard error of y-axis
lmod <- lm(prob ~ int_fit, data = totsed.tm)
lpred <- data.frame(int_fit = totsed.tm$int_fit, prob = predict(lmod, totsed.tm ))
summary(lmod)$r.squared
summary(lmod)$coefficients[,4][2]


# Plot
total <- ggplot(totsed.tm , aes(x = int_fit, y = prob)) + 
  geom_errorbar(aes(ymin = prob - SE, ymax = prob + SE), lwd = 0.2) +
  geom_errorbarh(aes(xmin = int_min, xmax = int_max), lwd = 0.2) +
  geom_point() +
  #geom_line(data = lpred, linetype = 1) +
  labs(x = "Total ALL sediment deposited (g)",
       y = "Probability of total mortality",
       title = "All sediments") +
  geom_text_repel(aes(label = paste(reef, dir, channel)), size = 2.5) +
  theme_few()
total
```

