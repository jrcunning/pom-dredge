---
title: "sediment_cover.Rmd"
author: "Ross Cunning"
date: "6/3/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Load packages
library(furrr)
library(MASS)
library(tidyverse)
library(lubridate)
library(lsmeans)
library(gamm4)
library(lme4)

# Plan for parallel processing
plan(multiprocess)

# Define function to convert logit to probability
logit2prob <- function(logit){
  odds <- exp(logit)
  prob <- odds / (1 + odds)
  return(prob)
}
```

# Load data
```{r}
# Load both versions of CPCe data (see tidy_cpce_data.Rmd)
load("data/cpce_spr_as_sand.RData")
load("data/cpce_omit_nosand.RData")

# Choose which version of CPCe data to use
cpce <- cpce_spr_as_sand
#cpce <- cpce_omit_nosand
```

# Quantify sand cover
```{r, quantify_sand}
# Count sand vs. not sand, and create numeric weeks column
cpce <- cpce %>%
  mutate(sumpts = rowSums(select_if(., is.integer)),     # sum counts of all categories
         notsand = as.integer(sumpts - sand_sa)) %>%     # sum counts of not sand
  mutate_if(is.character, as.factor) %>%
  mutate(weekn = (date - min(date)) / dweeks(1),  # create numeric weeks column
         dayn  = as.numeric(date - min(date)))

# Define start and end of dredging (for plotting)
dredge.start.date <- as.Date("2013-11-20")                  # NOAA sediment report April 2016, page 44
dredge.end.date <- as.Date("2015-03-16")                    # DCA report August 2015, page 3
```

# Visualize mean sand cover over time at each site
```{r}
# Calculate mean proportion sand cover at each site on each date 
# (averaged across all frames from all transects)
sand.summ <- cpce %>%
  mutate(propsand = sand_sa / sumpts) %>%
  group_by(reef, dir, channel, site, date) %>%
  summarise(meanpropsand = mean(propsand)) %>%
  ungroup()

# Plot by site
ggplot(sand.summ, aes(x = date, y = meanpropsand, color = channel, group = site)) +
  facet_wrap(~ site) +
  geom_point() +
  geom_line() +
  geom_vline(xintercept = c(dredge.start.date, dredge.end.date), linetype = 3, lwd = 0.25)

# Plot by reef and direction
ggplot(sand.summ, aes(x = date, y = meanpropsand, color = channel, group = site,
               linetype = channel)) +
  facet_grid(dir ~ reef) +
  geom_point() +
  geom_line() +
  geom_vline(xintercept = c(dredge.start.date, dredge.end.date), linetype = 1, lwd = 0.25)
```

# Filter out HBN1 and HBN2

Sites HBN1 and HBN2 have a high amount of sand cover to begin with, and they are classified in DCA reports as "Scattered Coral/Rock in Sand". The rest of the sites are all categorized as "Colonized Pavement", "Ridge Reef", "Linear Reef", or "Spur and Groove", and generally have lower amounts of sand. Therefore, the HBN1 and HBN2 sites should be omitted.
```{r}
cpce <- cpce %>% 
  filter(!site %in% c("HBN1", "HBN2"))

# Calculate mean proportion sand cover at each site on each date 
# (averaged across all frames from all transects)
sand.summ <- cpce %>%
  mutate(propsand = sand_sa / sumpts) %>%
  group_by(reef, dir, channel, site, date) %>%
  summarise(meanpropsand = mean(propsand)) %>%
  ungroup()
```

# Model sand cover

### Fit GAMMs for each reef and direction (site as random effect)
```{r}
# Filter dataset to only fit over regions with less than 30-week gaps between data points
cpce.f <- cpce %>%
  nest(-reef, -dir, -channel) %>%                                            # For each reef
  mutate(dates = map(data, ~ sort(unique(.$date))),                         # Which weeks have data
          runs = map(dates, ~ split(.x, cumsum(c(TRUE, diff(.x) > 140)))),  # Find runs w/o 20wk gaps
       longest = map(runs, ~ .x[[which.max(sapply(.x, length))]]),           # Get longest run
        data.f = map2(data, longest, ~ filter(.x, .$date %in% .y))) %>%   # Get data from those dates
  unnest(data.f)

# Add up the total number of points counted as sand and not sand across all frames from each transect/date
cpce.f <- cpce.f %>%
  group_by(reef, dir, channel, site, transect, dayn) %>%
  summarise(sand = sum(sand_sa),
            notsand = sum(notsand)) %>%
  ungroup()

# Fit GAMM models for each reef and direction
gamms.reef.dir <- cpce.f %>%
  #filter(reef == "R2", dir == "S") %>%     # UNCOMMENT TO LOOK ONLY AT R2S (TESTING...)
  nest(-reef, -dir) %>%   # Nest by reef and direction
  mutate(
    # Fit gamm by channel (in parallel)
    mod = future_map(data, 
            ~ gamm4(cbind(sand, notsand) ~ s(dayn, by = channel) + channel, ##, k = 8, bs = "cs"
                    random = ~(1|site/transect), data = ., family = "binomial")$gam),
    # Get newdata frame for predict() using the appropriate range of weeks
    newdata = map(data, ~ expand.grid(dayn = min(.$dayn):max(.$dayn),
                                      channel = c("channelside", "control"))),
    # Get fitted values from GAMM using newdata frame
    fit = map2(mod, newdata, ~ predict(object = .x, newdata = .y, type = "response")),
    # Get confidence intervals by simulation
    Rbeta = map(mod, ~ mvrnorm(n = 1000, coef(.), vcov(.))),
    Xp = map2(mod, newdata, ~ predict(object = .x, newdata = .y, type = "lpmatrix")),
    sim = map2(Xp, Rbeta, function(x, y) x %*% t(y)),
    lci = map(sim, ~ logit2prob(apply(., 1, quantile, 0.08))),
    uci = map(sim, ~ logit2prob(apply(., 1, quantile, 0.92)))
  )

gamms.reef.dir.fits <- gamms.reef.dir %>% 
  unnest(newdata, fit, lci, uci) %>%
  mutate(date = min(cpce$date) + dayn)

save(sand.summ, gamms.reef.dir.fits, file = "data/sedcov.gamms.RData")

```

### Plot fitted models
```{r}
ggplot(gamms.reef.dir.fits, aes(x = date, y = fit, color = channel)) +
  facet_grid(dir ~ reef) +
  geom_point(data = sand.summ, aes(y = meanpropsand), alpha = 0.4) +
  geom_ribbon(aes(ymin = lci, ymax = uci, linetype = NA), alpha = 0.2) + 
  geom_line(lwd = 1) +
  geom_vline(xintercept = c(dredge.start.date, dredge.end.date), linetype = 3, lwd = 0.25) +
  labs(title = "Sand cover", x = "Date", y = "Percent sand")
```

# Assess 'permanent' effects
```{r, fig.width = 6, fig.height = 6}
# Show percent sand at each site for TRUE baseline (must be before Nov. 20, 2013) and late 2016
ba <- cpce %>%
  filter(date < as.Date("2013-11-20") | date > as.Date("2016-01-01")) %>%
  group_by(reef, dir, channel, site, date, transect) %>%
  summarize(propsand = mean(sand_sa / sumpts)) %>%
  group_by(reef, dir, channel, site, year = factor(year(date))) %>%
  summarize(meanpropsand = mean(propsand),
            sd = sd(propsand))

ggplot(ba, aes(x = year, y = meanpropsand, fill = year)) +
  facet_wrap(~ site) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = meanpropsand - sd, ymax = meanpropsand + sd), 
                width = 0.5, lwd = 0.3) +
  scale_fill_manual(values = c("cornflowerblue", "coral")) +
  theme(legend.position = c(0.75, 0.075))
```

There are only three sites for which CPCE data exist both before dredging began, and then in 2016: R2N1, R2S1, and R2SC1.
```{r}
ba %>%
  filter(site %in% c("R2N1", "R2S1", "R2SC1")) %>%
  ggplot(aes(x = year, y = meanpropsand, fill = year)) +
  facet_wrap(~ site) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = meanpropsand - sd, ymax = meanpropsand + sd), 
                width = 0.5, lwd = 0.3) +
  scale_fill_manual(values = c("cornflowerblue", "coral")) +
  theme(legend.position = c(0.75, 0.075))
```

