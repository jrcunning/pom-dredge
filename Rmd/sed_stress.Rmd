---
title: "Coral sedimentation stress during PortMiami dredge"
author: "Ross Cunning"
date: "5/27/2018"
output: html_document
---

# Setup
```{r setup, include = FALSE}
# Set knitr options
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
# Load packages
library(tidyverse)
library(lubridate)
library(lme4)
library(lsmeans)
library(mgcv)
library(gamm4)
library(MASS)

# Define function for accessing corals with specific condition codes
hasCond <- function(cond, Condition.Codes) {
  unlist(lapply(Condition.Codes, FUN=function(x) any(grepl(cond, x))))
}

# Convert logit to probability
logit2prob <- function(logit){
  odds <- exp(logit)
  prob <- odds / (1 + odds)
  return(prob)
}
```

# Import data

We will analyze the complete tagged coral dataset.

```{r}
# Import tidy tagged coral data
load("../data/tagged_corals.RData")

# Define start and end of dredging (for plotting)
dredge.start.date <- as.Date("2013-11-20")                  # NOAA sediment report April 2016, page 44
dredge.start.wk <- (dredge.start.date - min(alldata$Date)) / dweeks(1)
dredge.end.date <- as.Date("2014-12-31")                    # DCA report August 2015, page 3
dredge.end.wk <- (dredge.end.date - min(alldata$Date)) / dweeks(1)
```

#### Aggregate all data by week number

Different sites were observed on different dates. For this reason, we will bin dates by week number starting at the earliest date on which data were collected.

```{r}
# Assign week number for all observations based on number of weeks since earliest data
alldata <- alldata %>%
  mutate(weekn = trunc((Date - min(Date)) / dweeks(1)))

# Some of the the corals were observed multiple times per "week" - need to aggregate condition codes
allweeks <- alldata %>%
  group_by(Site, reef, dir, Channel, Species, coral, weekn) %>%
  do(Condition.Codes = unique(unlist(c(.$Condition.Codes)))) %>%
  ungroup()
```

#### Quantify sedimentation stress

Several different condition codes were used to document impacts of sedimentation on corals:

* SA = sediment accumulation on the colony
* PBUR = partial burial of the colony
* BUR = complete burial of the colony

Here, we quantify and analyze "sedimentation stress" as the presence of any of these three condition codes.

```{r}
# Quantify sedimentation stress for living corals only
allweeks <- allweeks %>%
  filter(!hasCond("DEAD", Condition.Codes)) %>%       # Only look at living corals
  mutate(  SA = hasCond("^SA$", Condition.Codes),     # Did coral have sediment accumulation?
         PBUR = hasCond("^PBUR$", Condition.Codes),   # Was coral partially buried in sediment?
          BUR = hasCond("^BUR$", Condition.Codes),    # Was coral fully buried in sediment?
    SEDSTRESS = hasCond("^SA$|^PBUR$|^BUR$", Condition.Codes))  # Any of these conditions?  
```

# Sedimentation stress over time
```{r}
# Get proportion of corals with sedimentation stress for each reef/dir at each week
sedstress.summ <- allweeks %>%
  group_by(reef, dir, Channel, weekn) %>%
  summarise(n = n(),
            SEDSTRESS = sum(SEDSTRESS),
            prop = SEDSTRESS / n)

# Plot proportions
ggplot(sedstress.summ, aes(x = weekn, y = prop, color = Channel)) + 
  facet_grid(dir ~ reef) +
  geom_point(aes(size = n)) +
  scale_size(range = c(0.1, 2.5)) +
  geom_smooth(method = "loess", se = FALSE)
```

These plots with local regression smoothing show that sedimentation stress was much greater at channelside sites relative to controls. However, there are some gaps in the data that are causing some artifacts in the smoothing. To eliminate these artifacts, and generate more robust statistical fits for the dataset, we can fit generalized additive mixed models (GAMMs) and use only the regions in the data without large gaps in time.

# Model sedimentation stress using GAMMs
```{r}
# Filter dataset to only fit over regions with less than 20-week gaps between data points
allweeks.f <- allweeks %>%
  nest(-reef, -dir, -Channel) %>%                                            # For each reef
  mutate(weeks = map(data, ~ sort(unique(.$weekn))),                         # Which weeks have data
          runs = map(weeks, ~ split(.x, cumsum(c(TRUE, diff(.x) > 20)))),    # Find runs w/o 20wk gaps
       longest = map(runs, ~ .x[[which.max(sapply(.x, length))]]),           # Get longest run
        data.f = map2(data, longest, ~ filter(.x, .$weekn %in% .y))) %>%     # Get data from those weeks
  unnest(data.f)

# Fit GAMMs for each reef
dd <- allweeks.f %>%
  # For each reef (R2N, R2S, R3N, R3S)
  nest(-reef, -dir) %>%
  mutate(
    # Fit a binomial GAMM for sediment stress over time at channelside vs. control, site as random
    mod = map(data, ~ gamm4(SEDSTRESS ~ s(weekn, by = factor(Channel), k = 5) + Channel,
                                 random = ~ (1|Site), family = "binomial", data = .)$gam),
    # Get newdata frame for predict() using the appropriate range of weeks
    newdata = map(data, ~ expand.grid(weekn = min(.$weekn):max(.$weekn),
                                      Channel = c("channelside", "control"))),
    # Get fitted values from GAMM using newdata frame
    fit = map2(mod, newdata, ~ predict(object = .x, newdata = .y, type = "response")),
    # Get confidence intervals by simulation
    Rbeta = map(mod, ~ mvrnorm(n = 1000, coef(.), vcov(.))),
    Xp = map2(mod, newdata, ~ predict(object = .x, newdata = .y, type = "lpmatrix")),
    sim = map2(Xp, Rbeta, function(x, y) x %*% t(y)),
    lci = map(sim, ~ logit2prob(apply(., 1, quantile, 0.08))),
    uci = map(sim, ~ logit2prob(apply(., 1, quantile, 0.92)))
  ) %>% unnest(newdata, fit, lci, uci)

# Plot
fig <- dd %>%
  ggplot(aes(x = weekn, y = fit, color = Channel)) +
    facet_grid(dir ~ reef) +
    geom_point(data = sedstress.summ, aes(y = prop, size = n)) +
    scale_size(range = c(0.1, 2.5)) +
    geom_line() +
    geom_ribbon(aes(ymin = lci, ymax = uci, linetype = NA), alpha = 0.3) + 
    geom_vline(xintercept = c(dredge.start.wk, dredge.end.wk), linetype = 1, lwd = 0.25)

fig 
```

Why is there so much sediment stress at control sites? Either some of these condition codes (e.g., SA) don't really reflect dredging sediment, or the control sites were actually impacted by dredging sediment.

# Look at just PBUR and BUR
```{r}
# Get proportion of corals with sedimentation stress for each reef/dir at each week
sedstress.summ <- allweeks %>%
  group_by(reef, dir, Channel, weekn) %>%
  summarise(n = n(),
            SEDSTRESS = sum(PBUR|BUR),
            prop = SEDSTRESS / n)

# Plot proportions
ggplot(sedstress.summ, aes(x = weekn, y = prop, color = Channel)) + 
  facet_grid(dir ~ reef) +
  geom_point(aes(size = n)) +
  scale_size(range = c(0.1, 2.5)) +
  geom_smooth(method = "loess", se = FALSE)

# Fit GAMMs for each reef
dd <- allweeks.f %>%
  # For each reef (R2N, R2S, R3N, R3S)
  nest(-reef, -dir) %>%
  mutate(
    # Fit a binomial GAMM for sediment stress over time at channelside vs. control, site as random
    mod = map(data, ~ gamm4(PBUR|BUR ~ s(weekn, by = factor(Channel), k = 5) + Channel,
                                 random = ~ (1|Site), family = "binomial", data = .)$gam),
    # Get newdata frame for predict() using the appropriate range of weeks
    newdata = map(data, ~ expand.grid(weekn = min(.$weekn):max(.$weekn),
                                      Channel = c("channelside", "control"))),
    # Get fitted values from GAMM using newdata frame
    fit = map2(mod, newdata, ~ predict(object = .x, newdata = .y, type = "response")),
    # Get confidence intervals by simulation
    Rbeta = map(mod, ~ mvrnorm(n = 1000, coef(.), vcov(.))),
    Xp = map2(mod, newdata, ~ predict(object = .x, newdata = .y, type = "lpmatrix")),
    sim = map2(Xp, Rbeta, function(x, y) x %*% t(y)),
    lci = map(sim, ~ logit2prob(apply(., 1, quantile, 0.08))),
    uci = map(sim, ~ logit2prob(apply(., 1, quantile, 0.92)))
  ) %>% unnest(newdata, fit, lci, uci)

# Plot
fig <- dd %>%
  ggplot(aes(x = weekn, y = fit, color = Channel)) +
    facet_grid(dir ~ reef) +
    geom_point(data = sedstress.summ, aes(y = prop, size = n), alpha = 0.3) +
    scale_size(range = c(0.1, 2.5)) +
    geom_line() +
    geom_ribbon(aes(ymin = lci, ymax = uci, linetype = NA), alpha = 0.3) +
    geom_vline(xintercept = c(dredge.start.wk, dredge.end.wk), linetype = 1, lwd = 0.25)

fig
```

##### Break this down by site for the northern middle reef

```{r}
# Get proportion of corals with sedimentation stress for each reef/dir at each week
sedstress.summ <- allweeks %>%
  filter(reef=="R2", dir == "N") %>%
  group_by(reef, dir, Channel, Site, weekn) %>%
  summarise(n = n(),
            SEDSTRESS = sum(PBUR|BUR),
            prop = SEDSTRESS / n)

# Plot proportions
ggplot(sedstress.summ, aes(x = weekn, y = prop, color = Channel)) + 
  facet_wrap(Site ~ .) +
  geom_point(aes(size = n)) +
  scale_size(range = c(0.1, 2.5)) +
  geom_smooth(method = "loess", se = FALSE)
```


